<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ApexiA QG | Elite Community</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    
    <!-- Motores do Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root { --primary: #00FF00; --bg: #030303; --border: rgba(0, 255, 0, 0.15); --wa-bg: #0b141a; --wa-msg-out: #005c4b; --wa-msg-in: #202c33; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background: #000; color: #fff; height: 100dvh; overflow: hidden; display: flex; }

        /* --- FUNDO GALÁXIA --- */
        #galaxy { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at center, #0a1a0a 0%, #000 100%); }
        .star { position: absolute; background: white; border-radius: 50%; opacity: 0.5; animation: moveStar linear infinite; }
        @keyframes moveStar { from { transform: translateY(0); } to { transform: translateY(-1000px); } }

        /* --- SIDEBAR WHATSAPP STYLE --- */
        #sidebar { 
            width: 300px; background: #111b21; border-right: 1px solid var(--border);
            display: flex; flex-direction: column; transition: 0.3s;
        }
        .sidebar-header { padding: 20px; background: #202c33; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .my-profile-img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary); object-fit: cover; }
        
        #members-list { flex: 1; overflow-y: auto; padding: 10px 0; }
        .member-item { display: flex; align-items: center; gap: 12px; padding: 12px 20px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.03); transition: 0.2s; }
        .member-item:hover { background: #2a3942; }
        .member-item img { width: 45px; height: 45px; border-radius: 50%; border: 1px solid var(--border); }
        .member-info b { font-size: 0.9rem; display: block; }
        .member-info span { font-size: 0.7rem; color: var(--primary); }

        /* --- ÁREA DO CHAT --- */
        #chat-area { flex: 1; display: flex; flex-direction: column; background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; background-color: #0b141a; }
        header { padding: 10px 20px; background: #202c33; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid var(--border); }
        .group-icon { width: 40px; height: 40px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 900; color: #000; }

        #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        
        /* Balões WhatsApp */
        .msg { max-width: 65%; padding: 8px 12px; border-radius: 8px; font-size: 0.9rem; position: relative; animation: pop 0.2s ease; }
        @keyframes pop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .msg.sent { align-self: flex-end; background: var(--wa-msg-out); color: #fff; border-top-right-radius: 0; }
        .msg.received { align-self: flex-start; background: var(--wa-msg-in); border-top-left-radius: 0; }
        
        .msg-sender { font-size: 0.7rem; font-weight: 900; color: var(--primary); margin-bottom: 3px; display: block; }
        .msg-time { font-size: 0.6rem; opacity: 0.5; float: right; margin-top: 5px; margin-left: 10px; }

        /* --- INPUT NEON --- */
        .input-area { padding: 10px 20px; background: #202c33; display: flex; align-items: center; gap: 10px; }
        .input-wrapper { 
            flex: 1; display: flex; gap: 10px; background: #2a3942; padding: 10px 20px; border-radius: 30px; 
            border: 1px solid transparent; transition: 0.3s;
        }
        .input-wrapper:focus-within { border-color: var(--primary); box-shadow: 0 0 15px rgba(0,255,0,0.1); }
        input { flex: 1; background: transparent; border: none; color: #fff; outline: none; }
        
        .btn-send { width: 45px; height: 45px; border-radius: 50%; background: var(--primary); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }

        /* --- TELA DE CADASTRO (ONBOARDING) --- */
        #onboarding { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .form-card { width: 100%; max-width: 400px; background: #111; padding: 30px; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 0 40px rgba(0,255,0,0.1); }
        .form-card h2 { margin-bottom: 20px; text-align: center; }
        .form-card h2 span { color: var(--primary); }
        .form-card input { width: 100%; padding: 15px; margin-bottom: 15px; background: #000; border: 1px solid #333; border-radius: 10px; color: #fff; outline: none; }
        .form-card input:focus { border-color: var(--primary); }
        .btn-ready { width: 100%; padding: 15px; background: var(--primary); color: #000; font-weight: 900; border: none; border-radius: 50px; cursor: pointer; transition: 0.3s; }

        @media (max-width: 768px) { #sidebar { display: none; } .msg { max-width: 85%; } }
    </style>
</head>
<body>
    <div id="galaxy"></div>

    <!-- TELA DE CADASTRO WHATSAPP STYLE -->
    <div id="onboarding">
        <div class="form-card">
            <h2>QG <span>APEXIA</span></h2>
            <p style="color:#666; font-size: 0.8rem; text-align:center; margin-bottom: 20px;">Crie sua identidade de membro para entrar.</p>
            
            <input type="text" id="reg-name" placeholder="Seu Nome Real">
            <input type="text" id="reg-channel" placeholder="Nome do seu Canal">
            <input type="tel" id="reg-whatsapp" placeholder="WhatsApp: (XX) XXXXX-XXXX">
            <input type="text" id="reg-photo" placeholder="Link da Foto (Opcional)">
            
            <button class="btn-ready" onclick="finalizeJoin()">ENTRAR NO GRUPO</button>
        </div>
    </div>

    <div id="app" style="display:none; width: 100%; display: flex;">
        <nav id="sidebar">
            <div class="sidebar-header">
                <img src="" id="my-avatar" class="my-profile-img">
                <div style="font-weight: 900; font-size: 0.7rem; color: var(--primary);">MEU PERFIL</div>
            </div>
            <div id="members-list">
                <!-- Membros online aqui -->
            </div>
        </nav>

        <main id="chat-area">
            <header>
                <div class="group-icon">A</div>
                <div>
                    <div style="font-weight: 900; font-size: 0.9rem;">QG ApexiA - Elite</div>
                    <div style="font-size: 0.6rem; color: var(--primary);" id="online-count">carregando membros...</div>
                </div>
            </header>

            <div id="chat-window"></div>

            <div class="input-area">
                <div class="input-wrapper">
                    <input type="text" id="chat-input" placeholder="Mensagem...">
                </div>
                <button class="btn-send" onclick="sendMessage()">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="black"><path d="M1.101 21.757L23.8 12.028 1.101 2.3l.011 7.912 13.623 1.816-13.623 1.817-.011 7.912z"></path></svg>
                </button>
            </div>
        </main>
    </div>

    <script>
        // CONFIGURAÇÃO DO SEU FIREBASE (Extraído da sua foto)
        const firebaseConfig = {
            apiKey: "AIzaSyBhdI1v1_3ycms26YQdYhy0_GSuuh2ZvJA",
            authDomain: "comunidade-apexia.firebaseapp.com",
            projectId: "comunidade-apexia",
            databaseURL: "https://comunidade-apexia-default-rtdb.firebaseio.com",
            storageBucket: "comunidade-apexia.firebasestorage.app",
            messagingSenderId: "668289488372",
            appId: "1:668289488372:web:cf29801db6489d09a695a1"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let myData = null;

        // --- SISTEMA DE NOTIFICAÇÃO ---
        function requestNotify() {
            if (Notification.permission !== "granted") {
                Notification.requestPermission();
            }
        }

        // --- FINALIZAR CADASTRO ---
        function finalizeJoin() {
            const name = document.getElementById('reg-name').value.trim();
            const channel = document.getElementById('reg-channel').value.trim();
            const wa = document.getElementById('reg-whatsapp').value.trim();
            const photo = document.getElementById('reg-photo').value.trim() || "https://via.placeholder.com/100/00FF00/000000?text=Member";

            if(name && channel && wa) {
                myData = { id: Date.now(), name, channel, wa, photo };
                localStorage.setItem('apexia_user', JSON.stringify(myData));
                document.getElementById('onboarding').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                document.getElementById('my-avatar').src = photo;
                
                requestNotify();
                confetti({ particleCount: 150, origin: { y: 0.6 } });
                setupPresence();
                startChat();
            } else {
                alert("Preencha os campos obrigatórios!");
            }
        }

        // --- SISTEMA DE PRESENÇA ---
        function setupPresence() {
            const myStatusRef = db.ref(`status/${myData.id}`);
            db.ref('.info/connected').on('value', (snap) => {
                if (snap.val() === true) {
                    myStatusRef.onDisconnect().remove().then(() => {
                        myStatusRef.set({ name: myData.name, photo: myData.photo, channel: myData.channel });
                    });
                }
            });

            db.ref('status').on('value', (s) => {
                const list = document.getElementById('members-list');
                const countEl = document.getElementById('online-count');
                list.innerHTML = "";
                let count = 0;
                s.forEach(child => {
                    const d = child.val();
                    list.innerHTML += `
                        <div class="member-item">
                            <img src="${d.photo}">
                            <div class="member-info">
                                <b>${d.name}</b>
                                <span>${d.channel}</span>
                            </div>
                        </div>`;
                    count++;
                });
                countEl.innerText = `${count} membros online agora`;
            });
        }

        // --- ENVIO DE MENSAGEM ---
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(text && myData) {
                db.ref("group_chat").push({
                    senderId: myData.id,
                    senderName: myData.name,
                    text: text,
                    timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                });
                input.value = "";
            }
        }

        // --- OUVIR CHAT ---
        function startChat() {
            db.ref("group_chat").limitToLast(50).on("child_added", (snap) => {
                const m = snap.val();
                const win = document.getElementById('chat-window');
                const isMe = m.senderId === myData.id;
                
                const div = document.createElement('div');
                div.className = `msg ${isMe ? 'sent' : 'received'}`;
                div.innerHTML = `
                    ${!isMe ? `<span class="msg-sender">${m.senderName}</span>` : ''}
                    ${m.text}
                    <span class="msg-time">${m.timestamp}</span>
                `;
                win.appendChild(div);
                win.scrollTop = win.scrollHeight;

                // Notificação se não for eu
                if(!isMe && document.hidden) {
                    new Notification(`ApexiA Community`, { body: `${m.senderName}: ${m.text}`, icon: 'canalapexia.png' });
                }
            });
        }

        // Estrelas
        const g = document.getElementById('galaxy');
        for (let i = 0; i < 60; i++) {
            const s = document.createElement('div');
            s.className = 'star';
            s.style.width = s.style.height = Math.random() * 3 + 'px';
            s.style.left = Math.random() * 100 + '%';
            s.style.top = Math.random() * 100 + '%';
            s.style.animationDuration = (Math.random() * 50 + 30) + 's';
            g.appendChild(s);
        }

        document.getElementById('chat-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
        
        // Auto-login se já tiver perfil
        window.onload = () => {
            const saved = localStorage.getItem('apexia_user');
            if(saved) {
                myData = JSON.parse(saved);
                document.getElementById('onboarding').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                document.getElementById('my-avatar').src = myData.photo;
                setupPresence();
                startChat();
            }
        };
    </script>
</body>
</html>

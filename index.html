<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="manifest.json">
    <title>ApexiA HQ | Comunidade Suprema</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- // ===============================
         // IN√çCIO NOVA FUNCIONALIDADE: INTERCEPTOR DE CONSULTA OTIMIZADA
         // Isso garante ordena√ß√£o e limite de 50 SEM alterar a fun√ß√£o ouvirChat original!
         // =============================== -->
    <script>
        const apexia_origLimit = firebase.database.Query.prototype.limitToLast;
        firebase.database.Query.prototype.limitToLast = function(limit) {
            if (limit === 30 || limit === 100) {
                return this.orderByChild("timestamp").limitToLast(50);
            }
            return apexia_origLimit.call(this, limit);
        };
    </script>
    <!-- // ===============================
         // FIM NOVA FUNCIONALIDADE
         // =============================== -->

    <style>
        :root { --primary: #00FF00; --bg: #030303; --border: rgba(0, 255, 0, 0.2); --gold: #FFD700; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: #000; color: #fff; height: 100dvh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; }

        /* --- FUNDO GAL√ÅXIA --- */
        #galaxy { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at center, #0a1a0a 0%, #000 100%); }
        .star { position: absolute; background: white; border-radius: 50%; opacity: 0.5; animation: moveStar 100s linear infinite; }
        @keyframes moveStar { from { transform: translateY(0); } to { transform: translateY(-1000px); } }

        /* --- TELAS --- */
        #onboarding, #waiting-screen, #app, #returning-login { display: none; width: 100%; height: 100dvh; position: fixed; inset: 0; z-index: 100; background: #000; }

        /* // IN√çCIO NOVA FUNCIONALIDADE: CSS ADICIONAL ESPERA E PERFIL // */
        .apexia_progress_bar { width: 100%; height: 6px; background: rgba(255,255,255,0.05); border-radius: 10px; margin: 20px 0; overflow: hidden; }
        .apexia_progress_fill { width: 45%; height: 100%; background: var(--primary); box-shadow: 0 0 10px var(--primary); animation: apexia_pulse_loading 2s infinite ease-in-out; }
        @keyframes apexia_pulse_loading { 0% { opacity: 0.5; width: 30%; } 50% { opacity: 1; width: 60%; } 100% { opacity: 0.5; width: 30%; } }
        .apexia_support_link { display: inline-flex; align-items: center; gap: 8px; background: #25D366; color: #fff; padding: 12px 24px; border-radius: 50px; text-decoration: none; font-weight: 800; font-size: 0.8rem; margin-top: 15px; transition: 0.3s; }
        .apexia_support_link:hover { transform: scale(1.05); }
        .apexia_back_btn { background: rgba(0,255,0,0.1); border: 1px solid var(--primary); color: var(--primary); padding: 5px 12px; border-radius: 6px; font-size: 0.7rem; font-weight: 800; cursor: pointer; display: none; margin-right: 10px; }
        @media (max-width: 768px) { .apexia_back_btn { display: block; } }
        /* // FIM NOVA FUNCIONALIDADE // */

        /* --- TELA DE ESPERA PROFISSIONAL --- */
        #waiting-screen { flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        .waiting-card { width: 100%; max-width: 480px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 40px; border-radius: 30px; backdrop-filter: blur(20px); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .countdown { font-size: 2.2rem; font-weight: 900; color: var(--primary); margin: 20px 0; font-variant-numeric: tabular-nums; }
        #rejection-alert { display: none; background: rgba(255,0,0,0.1); border: 1px solid #ff4444; padding: 15px; border-radius: 15px; margin-top: 20px; color: #ff8888; text-align: left; }

        /* --- SIDEBAR --- */
        #sidebar { width: 280px; background: rgba(8, 8, 8, 0.95); border-right: 1px solid var(--border); display: flex; flex-direction: column; backdrop-filter: blur(10px); transition: 0.3s; }
        #members-list { flex: 1; overflow-y: auto; padding: 10px; }
        .member-card { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: 12px; margin-bottom: 8px; background: rgba(255,255,255,0.02); font-size: 0.8rem; cursor: pointer; }
        .member-card img { width: 35px; height: 35px; border-radius: 50%; border: 1px solid var(--primary); object-fit: cover; }

        /* --- CHAT AREA --- */
        #chat-area { flex: 1; display: flex; flex-direction: column; position: relative; min-width: 0; }
        #chat-area::before { content: ""; position: absolute; inset: 0; background: url('https://apexia-oficcial.github.io/ApexIA/canalapexia.png') no-repeat center; background-size: 30%; opacity: 0.03; pointer-events: none; }
        header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.8); }
        #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }

        /* --- BAL√ïES WHATSAPP STYLE --- */
        .msg { max-width: 80%; padding: 12px 18px; border-radius: 18px; font-size: 0.9rem; animation: slideIn 0.2s ease; word-wrap: break-word; cursor: pointer; }
        .received { align-self: flex-start; background: rgba(255,255,255,0.05); border-left: 3px solid var(--primary); border-radius: 2px 18px 18px 18px; }
        .sent { align-self: flex-end; background: var(--primary); color: #000; font-weight: 600; border-radius: 18px 18px 2px 18px; }
        
        .reply-quote { background: rgba(0,0,0,0.1); border-left: 3px solid #fff; padding: 5px 10px; margin-bottom: 5px; font-size: 0.75rem; border-radius: 5px; opacity: 0.7; }
        .reactions-bar { display: flex; gap: 5px; margin-top: 5px; }
        .react-btn { background: rgba(255,255,255,0.1); border: none; padding: 2px 6px; border-radius: 10px; color: #fff; font-size: 0.7rem; cursor: pointer; }

        /* --- INPUT NEON EM MOVIMENTO --- */
        .input-area { padding: 20px; background: #000; border-top: 1px solid var(--border); }
        #reply-preview { display: none; background: #111; padding: 10px 20px; border-top: 1px solid var(--primary); font-size: 0.8rem; justify-content: space-between; align-items: center; }
        .input-wrapper { 
            max-width: 900px; margin: 0 auto; display: flex; gap: 12px; background: #0a0a0a; 
            padding: 10px 18px; border-radius: 35px; align-items: center; position: relative; 
            overflow: hidden; border: 1px solid rgba(0, 255, 0, 0.3);
        }
        .input-wrapper::after {
            content: ""; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 0, 0.4), transparent);
            animation: neonFlow 3s infinite linear;
        }
        @keyframes neonFlow { 0% { left: -100%; } 100% { left: 100%; } }
        input { flex: 1; background: transparent; border: none; color: #fff; outline: none; z-index: 2; font-size: 1rem; }
        .send-btn { background: var(--primary); border: none; width: 38px; height: 38px; border-radius: 50%; cursor: pointer; font-weight: 900; z-index: 2; color: #000; }

        /* --- ADMIN DRAWER --- */
        #admin-drawer { display: none; position: fixed; right: 0; top: 0; bottom: 0; width: 340px; background: #050505; border-left: 2px solid var(--primary); z-index: 10001; padding: 20px; overflow-y: auto; box-shadow: -10px 0 30px #000; }
        .pending-card { background: #111; border: 1px solid #222; padding: 15px; border-radius: 15px; margin-bottom: 15px; }
        .pending-card img { width: 100%; border-radius: 10px; margin: 10px 0; }

        /* --- MODAIS ADICIONAIS --- */
        #profile-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal-box { width: 90%; max-width: 400px; background: #0a0a0a; border: 1px solid var(--primary); padding: 30px; border-radius: 25px; text-align: center; }
        .modal-box input, .modal-box textarea { width: 100%; padding: 12px; margin-top: 10px; background: #000; border: 1px solid #333; color: #fff; border-radius: 10px; outline: none; }

        @media (max-width: 768px) { #sidebar { position: fixed; transform: translateX(-100%); z-index: 10001; top: 0; bottom: 0; left: 0; } #sidebar.open { transform: translateX(0); } #admin-drawer { width: 100%; } }

        /* // ===============================
           // IN√çCIO NOVA FUNCIONALIDADE: CSS Polimento Avan√ßado, Admin, Scroll
           // =============================== */
           
        /* √ÅREA DE LOGIN PROFISSIONAL (DARK PREMIUM) */
        #onboarding .form-box, #returning-login .form-box { background: rgba(10, 10, 10, 0.85) !important; backdrop-filter: blur(20px) !important; border: 1px solid rgba(0, 255, 0, 0.2) !important; box-shadow: 0 20px 60px rgba(0,0,0,0.9), inset 0 0 20px rgba(0,255,0,0.05) !important; border-radius: 20px !important; padding: 45px 35px !important; max-width: 420px !important; width: 90% !important; }
        #onboarding .form-box input, #returning-login .form-box input { background: rgba(0,0,0,0.6) !important; border: 1px solid rgba(255,255,255,0.1) !important; border-radius: 12px !important; padding: 16px 20px !important; font-size: 0.95rem !important; margin-bottom: 15px !important; transition: 0.3s all !important; width: 100% !important; }
        #onboarding .form-box input:focus, #returning-login .form-box input:focus { border-color: var(--primary) !important; box-shadow: 0 0 15px rgba(0,255,0,0.15) !important; }
        #onboarding .btn-join, #returning-login .btn-join { background: linear-gradient(135deg, #00b300, #00ff00) !important; color: #000 !important; font-weight: 900 !important; border-radius: 12px !important; padding: 16px !important; margin-top: 10px !important; box-shadow: 0 10px 20px rgba(0,255,0,0.2) !important; text-transform: uppercase !important; letter-spacing: 1px !important; transition: transform 0.2s, box-shadow 0.2s !important; }
        #onboarding .btn-join:hover, #returning-login .btn-join:hover { transform: translateY(-2px) scale(1.02) !important; box-shadow: 0 15px 25px rgba(0,255,0,0.3) !important; }

        /* Identidade de Admin */
        .apexia_admin_badge { background: linear-gradient(45deg, #FFD700, #FFA500); color: #000; font-size: 0.55rem; padding: 2px 6px; border-radius: 4px; margin-left: 6px; font-weight: 900; vertical-align: middle; letter-spacing: 0.5px; box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
        .apexia_admin_msg { border: 1px solid rgba(255, 215, 0, 0.5) !important; box-shadow: 0 0 10px rgba(255, 215, 0, 0.1) !important; }

        /* Novo Bot√£o Assistir Agora - Pulsante Convers√£o */
        @keyframes apexia_pulse_conversion { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 255, 0, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(0, 255, 0, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 255, 0, 0); } }
        #apexia_video_banner_link { animation: apexia_pulse_conversion 2s infinite !important; background: var(--primary) !important; color: #000 !important; text-transform: uppercase; font-weight: 900 !important; border-radius: 50px !important; padding: 8px 20px !important; display: inline-block; margin-top: 8px; }

        /* Melhor Visual da Resposta */
        .apexia_quoted_msg { background: rgba(0,0,0,0.3) !important; border-left: 4px solid var(--primary) !important; padding: 8px 12px !important; margin-bottom: 8px !important; border-radius: 4px 12px 12px 4px !important; font-size: 0.75rem !important; color: #ddd !important; display: block; border-top: 1px solid rgba(255,255,255,0.05); border-right: 1px solid rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.05); cursor:pointer; }
        .apexia_quoted_msg b { color: var(--primary) !important; display: block; margin-bottom: 3px; font-size: 0.75rem; }
        
        #apexia_reply_preview { background: rgba(15,15,15,0.95) !important; backdrop-filter: blur(10px); border-top: 1px solid rgba(0,255,0,0.3) !important; border-left: 4px solid var(--primary) !important; padding: 12px 20px !important; border-radius: 15px 15px 0 0 !important; box-shadow: 0 -5px 20px rgba(0,0,0,0.5) !important; }
        #apexia_reply_name { color: var(--primary) !important; font-size: 0.8rem; display: block; margin-bottom: 4px; }

        /* Painel de Notifica√ß√µes Acumuladas */
        #apexia_notifications_panel { display: none; position: absolute; top: 60px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 350px; background: rgba(15,15,15,0.95); border: 1px solid var(--primary); border-radius: 15px; z-index: 2000; max-height: 300px; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.8); backdrop-filter: blur(10px); flex-direction: column; }
        .apexia_notif_item { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: 0.2s; }
        .apexia_notif_item:hover { background: rgba(0,255,0,0.05); }
        .apexia_notif_header { display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--primary); font-weight: bold; margin-bottom: 4px; }
        .apexia_notif_body { font-size: 0.75rem; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .apexia_notif_badge_click { cursor: pointer; transition: 0.2s; } .apexia_notif_badge_click:hover { transform: scale(1.1); }

        /* Bot√£o Scroll Down */
        #apexia_scroll_down { position: absolute; bottom: 80px; right: 20px; background: rgba(0,255,0,0.1); border: 1px solid var(--primary); color: var(--primary); width: 40px; height: 40px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; z-index: 50; backdrop-filter: blur(5px); box-shadow: 0 5px 15px #000; transition: 0.3s; }
        #apexia_scroll_down:hover { background: var(--primary); color: #000; }

        /* Envio Otimista */
        .apexia_optimistic { opacity: 0.6; filter: grayscale(50%); pointer-events: none; }

        /* Texto PC Maior */
        @media (min-width: 768px) { #chat-window .msg { font-size: 0.95rem !important; padding: 10px 16px !important; line-height: 1.4; } }
        
        /* Ajustes Remanescentes Anteriores (Oculta√ß√µes e Tamanho Base) */
        .apexia_foto_preview { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 1px solid var(--primary); margin-top: 10px; display: none; margin-left: auto; margin-right: auto; }
        button[onclick*="ApexIA/"] { display: none !important; }
        #chat-window .msg { padding: 6px 10px !important; font-size: 0.75rem !important; border-radius: 14px !important; box-shadow: 0 2px 5px rgba(0,0,0,0.3); position: relative; }
        #chat-window .received { border-radius: 2px 14px 14px 14px !important; }
        #chat-window .sent { border-radius: 14px 14px 2px 14px !important; }
        @keyframes apexia_pulse_vid { 0% { transform:scale(1); opacity:1; } 50% { transform:scale(1.3); opacity:0.6; } 100% { transform:scale(1); opacity:1; } }
        .apexia_anim_icon { display: inline-block; animation: apexia_pulse_vid 1s infinite; color: #FF4444; }
        
        /* Oculta o bot√£o PIN por padr√£o para todos (Liberado apenas via JS p/ admin) */
        .apexia_action_btn { display:none; position:absolute; top:-15px; right:10px; background:#111; border:1px solid var(--primary); border-radius:10px; padding:4px 8px; font-size:0.8rem; z-index: 5; box-shadow: 0 5px 15px #000; }
        .apexia_action_btn .apexia_pin_btn { display: none; }
        body.apexia_is_admin .apexia_action_btn .apexia_pin_btn { display: inline-block; }
        #chat-window .msg:hover .apexia_action_btn { display:flex; gap:8px; }
        
        @keyframes apexia_galaxy_bg { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .member-card img, #apexia_modal_foto, .apexia_foto_preview { background: linear-gradient(45deg, #000000, #0a1a0a, #003300, #000000); background-size: 400% 400%; animation: apexia_galaxy_bg 8s ease infinite; }
        .apexia_spinner { display: inline-block; width: 14px; height: 14px; margin-right: 8px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #000; border-radius: 50%; animation: apexia_spin_btn 0.8s linear infinite; vertical-align: middle; }
        @keyframes apexia_spin_btn { to { transform: rotate(360deg); } }
        @keyframes apexia_fadeInScreen { from { opacity: 0; transform: translateY(10px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        #onboarding, #waiting-screen, #app, #returning-login { animation: apexia_fadeInScreen 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* Fixado Mobile */
        .apexia_pin_expanded { white-space: normal !important; overflow: visible !important; position: absolute !important; top: 0; left: 0; right: 0; z-index: 1000; background: rgba(10, 30, 10, 0.95) !important; backdrop-filter: blur(10px); padding: 20px !important; border-bottom: 2px solid var(--primary) !important; box-shadow: 0 10px 30px rgba(0,0,0,0.9); flex-direction: column !important; align-items: flex-start !important; }
        .apexia_pin_expanded #apexia_pin_text { white-space: normal !important; overflow: visible !important; font-size: 0.9rem !important; line-height: 1.5; margin-top: 10px; }
        .apexia_pin_close_btn { display: none; align-self: flex-end; background: rgba(255,0,0,0.1); color: #ff4444; border: 1px solid #ff4444; padding: 6px 16px; border-radius: 8px; margin-top: 15px; font-weight: bold; font-size: 0.7rem; }
        .apexia_pin_expanded .apexia_pin_close_btn { display: block !important; }
        /* // ===============================
           // FIM NOVA FUNCIONALIDADE // */

        /* ===============================
           NOVA FUNCIONALIDADE: Menu de contexto, toast e contador de n√£o lidas
           =============================== */
        #apexia_msg_menu {
            position: fixed;
            display: none;
            flex-direction: column;
            gap: 6px;
            background: rgba(10, 10, 10, 0.96);
            border: 1px solid var(--primary);
            border-radius: 14px;
            padding: 10px 12px;
            z-index: 120000;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.9);
            min-width: 160px;
        }
        #apexia_msg_menu button {
            background: transparent;
            border: none;
            color: #eee;
            font-size: 0.78rem;
            text-align: left;
            padding: 4px 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            border-radius: 8px;
            transition: background 0.15s, transform 0.1s;
        }
        #apexia_msg_menu button span {
            width: 18px;
            text-align: center;
        }
        #apexia_msg_menu button:hover {
            background: rgba(0, 255, 0, 0.12);
            transform: translateX(2px);
        }
        #apexia_unread_since_banner {
            display: none;
            background: rgba(0, 255, 0, 0.06);
            border-bottom: 1px solid rgba(0, 255, 0, 0.4);
            padding: 6px 16px;
            font-size: 0.72rem;
            color: #ddd;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            z-index: 20;
        }
        #apexia_unread_since_banner b {
            color: var(--primary);
        }
        #apexia_unread_since_banner::before {
            content: "‚è±";
            font-size: 0.8rem;
            opacity: 0.9;
        }
        #apexia_sms_toast.apexia_toast_visible {
            transform: translate(-50%, 0);
        }

        /* Destaques / Not√≠cias */
        #apexia_news_carousel {
            display:none;
            background: rgba(5, 15, 5, 0.95);
            border-bottom: 1px solid rgba(0,255,0,0.3);
            padding: 8px 16px;
            display:flex;
            align-items:center;
            gap: 10px;
            overflow:hidden;
        }
        #apexia_news_carousel_img {
            width:56px;
            height:56px;
            border-radius:12px;
            object-fit:cover;
            border:1px solid rgba(0,255,0,0.5);
            flex-shrink:0;
        }
        #apexia_news_carousel_body {
            flex:1;
            min-width:0;
        }
        #apexia_news_carousel_title {
            font-size:0.78rem;
            font-weight:800;
            color:var(--primary);
            margin-bottom:2px;
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;
        }
        #apexia_news_carousel_desc {
            font-size:0.72rem;
            color:#ccc;
            max-height:2.2em;
            overflow:hidden;
        }
        .apexia_news_bullets {
            display:flex;
            gap:4px;
            margin-left:8px;
        }
        .apexia_news_dot {
            width:6px;
            height:6px;
            border-radius:50%;
            background:rgba(255,255,255,0.2);
        }
        .apexia_news_dot.active {
            background:var(--primary);
        }

        .apexia_reply_highlight {
            box-shadow: 0 0 0 2px rgba(0,255,0,0.7);
            transition: box-shadow 0.4s;
        }

        /* ============================
           CSS NOVO ‚Äì CHAT / SLIDES / REGRAS / REA√á√ïES
           ============================ */

        /* Fundo personalizado Apexia na √°rea de mensagens */
        #chat-window {
            position: relative;
        }
        #chat-window::before {
            content: "";
            position: absolute;
            inset: 0;
            pointer-events: none;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(0,255,0,0.12) 0, transparent 55%),
                radial-gradient(circle at 90% 80%, rgba(0,255,150,0.1) 0, transparent 55%),
                url('https://apexia-oficcial.github.io/ApexIA/canalapexia.png');
            background-repeat: no-repeat, no-repeat, no-repeat;
            background-size: 60% 60%, 70% 70%, 28%;
            background-position: 0% 0%, 100% 100%, center;
            opacity: 0.04;
            mix-blend-mode: screen;
            animation: apexia_chat_galaxy 26s ease-in-out infinite alternate;
        }

        @keyframes apexia_chat_galaxy {
            0% { transform: translate3d(0,0,0) scale(1); }
            50% { transform: translate3d(0,-4px,0) scale(1.02); }
            100% { transform: translate3d(0,0,0) scale(1.01); }
        }

        /* Regra do grupo fixa no topo do chat */
        .apexia_group_rule {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 18px;
            background: radial-gradient(circle at 0 0, rgba(0,255,0,0.16) 0, rgba(0,0,0,0.95) 55%);
            border-bottom: 1px solid rgba(0,255,0,0.4);
            font-size: 0.78rem;
            position: relative;
            z-index: 12;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .apexia_group_rule_icon {
            width: 26px;
            height: 26px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,255,0,0.15);
            border: 1px solid rgba(0,255,0,0.5);
            font-size: 1.1rem;
            animation: apexia_rule_wave 1.4s ease-in-out infinite;
        }
        .apexia_group_rule_content {
            flex: 1;
            min-width: 0;
        }
        .apexia_group_rule_title {
            font-size: 0.7rem;
            font-weight: 900;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--primary);
            margin-bottom: 2px;
        }
        .apexia_group_rule_text {
            font-size: 0.72rem;
            color: #ddd;
        }
        @keyframes apexia_rule_wave {
            0% { transform: translateY(0) rotate(0deg); }
            40% { transform: translateY(-1px) rotate(-12deg); }
            80% { transform: translateY(0) rotate(6deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }

        /* Carrossel de not√≠cias (slides) ‚Äì efeitos suaves topo */
        #apexia_news_carousel {
            position: relative;
            overflow: hidden;
        }
        #apexia_news_carousel::before,
        #apexia_news_carousel::after {
            content:"";
            position:absolute;
            top:0;
            bottom:0;
            width:40px;
            pointer-events:none;
            background:linear-gradient(to right, rgba(0,0,0,0.9), transparent);
            opacity:0.7;
        }
        #apexia_news_carousel::after {
            right:0;
            left:auto;
            transform:scaleX(-1);
        }
        #apexia_news_carousel::before {
            left:0;
        }
        #apexia_news_carousel.apexia_news_fade {
            animation: apexia_news_fadeIn 0.4s ease;
        }
        @keyframes apexia_news_fadeIn {
            from { opacity:0; transform:translateY(-4px); }
            to { opacity:1; transform:translateY(0); }
        }

        /* Modal do slide / an√∫ncio */
        .apexia_news_modal_box {
            width: 100%;
            max-width: 420px;
            background: radial-gradient(circle at top, rgba(0,255,0,0.16) 0, #050505 55%);
            border-radius: 22px;
            border: 1px solid rgba(0,255,0,0.5);
            padding: 22px 20px 20px;
            position: relative;
            box-shadow: 0 18px 45px rgba(0,0,0,0.8);
        }
        .apexia_news_modal_box img {
            width: 100%;
            max-height: 260px;
            object-fit: cover;
            border-radius: 18px;
            border: 1px solid rgba(0,255,0,0.4);
            margin-bottom: 12px;
        }
        .apexia_news_modal_box h3 {
            font-size: 0.95rem;
            font-weight: 800;
            margin-bottom: 6px;
            color: #fff;
        }
        .apexia_news_modal_box p {
            font-size: 0.8rem;
            color: #ddd;
            line-height: 1.5;
        }
        .apexia_news_modal_close {
            position:absolute;
            top:10px;
            right:14px;
            background:rgba(0,0,0,0.6);
            border:1px solid rgba(255,255,255,0.1);
            color:#fff;
            border-radius:999px;
            width:26px;
            height:26px;
            display:flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
            font-size:1.1rem;
        }

        /* Rea√ß√µes com emojis abaixo da mensagem */
        .apexia_reactions_bar {
            display: none;
            margin-top: 4px;
            gap: 4px;
            flex-wrap: wrap;
        }
        .apexia_reaction_chip {
            font-size: 0.7rem;
            background: rgba(0,0,0,0.4);
            border-radius: 999px;
            padding: 2px 7px 3px;
            border: 1px solid rgba(255,255,255,0.1);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        /* Bot√£o de instala√ß√£o PWA */
        #apexia_pwa_install {
            position: fixed;
            bottom: 18px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(5, 15, 5, 0.95);
            border: 1px solid rgba(0,255,0,0.6);
            color: var(--primary);
            padding: 8px 18px;
            border-radius: 999px;
            font-size: 0.8rem;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 6px;
            z-index: 120001;
            box-shadow: 0 10px 25px rgba(0,0,0,0.8);
            cursor: pointer;
        }
        #apexia_pwa_install span:first-child {
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <div id="galaxy"></div>

    <!-- TELA REGISTRO -->
    <div id="onboarding" style="display: flex; align-items: center; justify-content: center;">
        <div class="form-box" style="text-align: center; max-width: 400px; padding: 40px; background: #0a0a0a; border-radius: 30px; border: 1px solid var(--border);">
            <img src="https://apexia-oficcial.github.io/ApexIA/canalapexia.png" style="width:70px; margin-bottom:15px; border-radius:50%; border:2px solid var(--primary);">
            <h2 style="margin-bottom: 10px;">APX <span>APEXIA</span></h2>
            <p style="color:#666; font-size:0.75rem; margin-bottom:20px;">Exclusivo para membros reais.</p>
            <input type="text" id="reg-name" placeholder="Seu Nome">
            <input type="text" id="reg-channel" placeholder="Nome do seu Canal">
            <input type="tel" id="reg-whatsapp" placeholder="WhatsApp (ex: 244...)">
            <label for="reg-photo" style="display:block; padding:15px; background:#111; border:1px dashed #444; border-radius:10px; cursor:pointer; margin-bottom:15px; font-size:0.8rem; color:#888;" id="file-label">Anexar Print de Membro</label>
            <input type="file" id="reg-photo" accept="image/*" style="display:none" onchange="previewFile()">
            <button class="btn-join" style="width:100%; padding:16px; background:var(--primary); color:#000; font-weight:900; border:none; border-radius:50px; cursor:pointer;" onclick="solicitarAcesso()">SOLICITAR ACESSO</button>
            <p onclick="irParaLoginRapido()" style="margin-top:20px; font-size:0.7rem; color:var(--primary); cursor:pointer;">J√° √© membro aprovado? Clique aqui</p>
        </div>
    </div>

    <!-- LOGIN R√ÅPIDO -->
    <div id="returning-login" style="display: none; align-items: center; justify-content: center;">
        <div class="form-box" style="text-align: center; max-width: 400px; padding: 40px; background: #0a0a0a; border-radius: 30px; border: 1px solid var(--border);">
            <h2>RECONECTAR <span>AO CHAT</span></h2>
            <p style="color:#666; font-size:0.75rem; margin-bottom:25px;">Digite seu n√∫mero cadastrado.</p>
            <input type="tel" id="login-whatsapp" placeholder="WhatsApp">
            <button class="btn-join" style="width:100%; padding:16px; background:var(--primary); color:#000; font-weight:900; border:none; border-radius:50px; cursor:pointer;" onclick="loginRapido()">ENTRAR NO CHAT</button>
            <p onclick="location.reload()" style="margin-top:20px; font-size:0.7rem; color:#444; cursor:pointer;">Voltar ao cadastro</p>
        </div>
    </div>

    <!-- TELA ESPERA REFORMULADA -->
    <div id="waiting-screen">
        <div class="waiting-card">
            <div class="loader-ring"></div>
            <h2 style="font-weight: 900; letter-spacing: -1px;">AUDITORIA DE <span style="color:var(--primary)">MEMBRO</span></h2>
            <p style="color: #ccc; font-size: 0.9rem; margin-top: 15px; line-height: 1.6;">
                Estamos analisando seu pedido com aten√ß√£o para manter a exclusividade do grupo.
            </p>
            
            <div class="apexia_progress_container">
                <div class="apexia_progress_bar"><div class="apexia_progress_fill"></div></div>
                <p style="font-size: 0.65rem; color: #555; text-transform: uppercase; font-weight: 800;">Analisando autenticidade do Print...</p>
            </div>

            <div class="countdown" id="timer">24:00:00</div>
            
            <p style="color: #666; font-size: 0.8rem; margin-bottom: 20px;">
                O prazo m√©dio de aprova√ß√£o √© de <b>24 horas</b>. <br>
                Em per√≠odos de alta demanda, pode levar at√© 48h.
            </p>

            <div id="rejection-alert">
                <b style="color:#ff4444">ACESSO NEGADO:</b><br>
                <span id="rejection-reason" style="font-size: 0.85rem; color: #fff;">---</span>
            </div>

            <a href="https://wa.me/244931352915?text=Ol√°, solicitei acesso √† Comunidade ApexiA e gostaria de agilizar minha aprova√ß√£o." target="_blank" class="apexia_support_link">
                FALAR COM GESTOR NO WHATSAPP
            </a>
            <button onclick="sair()" style="margin-top:25px; background:none; border:none; color:#333; text-decoration:underline; cursor:pointer; font-size: 0.7rem;">Cancelar Solicita√ß√£o</button>
        </div>
    </div>

    <!-- ADMIN DRAWER -->
    <div id="admin-drawer">
        <h3 style="color:var(--primary); font-weight:900; margin-bottom:20px;">GEST√ÉO DE ACESSOS</h3>
        
        <div style="background:#111; padding:15px; border-radius:15px; margin-bottom:20px; border:1px solid var(--gold);">
            <h4 style="color:var(--gold); margin-bottom:10px; font-size:0.8rem;">üé• PUBLICAR NOVO V√çDEO</h4>
            <input type="text" id="apexia_video_title" placeholder="T√≠tulo do V√≠deo" style="width:100%; padding:10px; margin-bottom:10px; background:#000; border:1px solid #333; color:#fff; border-radius:8px;">
            <input type="url" id="apexia_video_link" placeholder="Link do YouTube/Plataforma" style="width:100%; padding:10px; margin-bottom:10px; background:#000; border:1px solid #333; color:#fff; border-radius:8px;">
            <input type="text" id="apexia_video_desc" placeholder="Breve descri√ß√£o" style="width:100%; padding:10px; margin-bottom:10px; background:#000; border:1px solid #333; color:#fff; border-radius:8px;">
            <button onclick="apexia_novoVideo()" style="width:100%; padding:10px; background:var(--gold); color:#000; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">ENVIAR NOTIFICA√á√ÉO</button>
        </div>

        <div style="background:#111; padding:15px; border-radius:15px; margin-bottom:20px; border:1px solid var(--primary);">
            <h4 style="color:var(--primary); margin-bottom:10px; font-size:0.8rem;">üì∞ NOT√çCIAS / DESTAQUES DA COMUNIDADE</h4>
            <input type="text" id="apexia_news_title" placeholder="T√≠tulo da Not√≠cia / Destaque" style="width:100%; padding:10px; margin-bottom:8px; background:#000; border:1px solid #333; color:#fff; border-radius:8px;">
            <textarea id="apexia_news_desc" placeholder="Descri√ß√£o curta" rows="2" style="width:100%; padding:10px; margin-bottom:8px; background:#000; border:1px solid #333; color:#ccc; border-radius:8px; resize:none;"></textarea>
            <label for="apexia_news_img" style="display:block; padding:8px 10px; margin-bottom:8px; font-size:0.75rem; border-radius:8px; border:1px dashed #333; color:#777; cursor:pointer;">üì∑ Imagem (opcional)</label>
            <input type="file" id="apexia_news_img" accept="image/*" style="display:none;">
            <button onclick="apexia_addNews()" style="width:100%; padding:8px; background:rgba(0,255,0,0.15); border:1px solid var(--primary); color:var(--primary); border-radius:999px; font-weight:bold; font-size:0.8rem; cursor:pointer;">+ ADICIONAR SLIDE</button>
            <p style="margin-top:6px; font-size:0.65rem; color:#666;">Imagens horizontais funcionam melhor. M√°x. alguns destaques ativos.</p>
        </div>

        <div id="pending-list"></div>
        <button onclick="toggleAdminDrawer()" style="width:100%; padding:15px; background:#222; border:none; color:#fff; border-radius:15px; cursor:pointer;">FECHAR PAINEL</button>
    </div>

    <!-- MODAL PERFIL (EXPANDIDO) -->
    <div id="profile-modal">
        <div class="modal-box">
            <h2 id="apexia_prof_title">MEU PERFIL <span>ELITE</span></h2>
            
            <img id="apexia_foto_preview_img" class="apexia_foto_preview">
            <label for="apexia_foto_input" style="display:block; padding:10px; background:#111; border:1px dashed var(--primary); border-radius:10px; cursor:pointer; margin-top:10px; font-size:0.75rem; color:#aaa;">üì∏ Escolher Foto Personalizada</label>
            <input type="file" id="apexia_foto_input" accept="image/*" style="display:none" onchange="apexia_uploadFotoPerfil(event)">

            <input type="text" id="apexia_p_name_input" placeholder="Seu Nome / Apelido (Opcional)" style="width:100%; padding:12px; margin-top:10px; background:#000; border:1px solid #333; color:var(--primary); font-weight:bold; border-radius:10px; outline:none;">

            <input type="text" id="p-nacionalidade" placeholder="Sua Nacionalidade">
            <input type="number" id="p-age" placeholder="Sua Idade">
            <input type="text" id="p-interests" placeholder="Interesses (ex: Games, Marketing)">
            <input type="tel" id="p-whatsapp-contato" placeholder="WhatsApp de Contato (Opcional)">
            <textarea id="p-bio" rows="4" placeholder="Sua biografia supremo..."></textarea>
            <button class="btn-join" style="width:100%;" onclick="salvarPerfil()">SALVAR ALTERA√á√ïES</button>
            <p onclick="document.getElementById('profile-modal').style.display='none'" style="margin-top:15px; font-size:0.8rem; cursor:pointer; color:#555;">Voltar</p>
        </div>
    </div>

    <!-- APP -->
    <div id="app">
        <nav id="sidebar">
            <div class="rank-box" style="padding:15px; border-bottom:1px solid var(--border);">
                <b style="font-size: 0.6rem; color:var(--gold);">‚≠ê RANKING ATIVIDADE</b>
                <div id="ranking-list" style="margin-top:5px; font-size:0.7rem; cursor:pointer;"></div>
            </div>
            <div id="members-list"></div>
            <div style="padding:20px; border-top:1px solid var(--border);">
                <button onclick="toggleAdminDrawer()" id="admin-btn" style="display:none; width:100%; padding:10px; background:var(--primary); color:#000; font-weight:900; border:none; border-radius:10px; margin-bottom:10px;">PAINEL GEST√ÉO</button>
                <button onclick="document.getElementById('profile-modal').style.display='flex'" style="width:100%; padding:10px; background:#111; color:var(--primary); border:1px solid var(--primary); border-radius:10px; margin-bottom:10px; font-weight:900; cursor:pointer;">MEU PERFIL</button>
                <button onclick="sair()" style="color:#555; background:none; border:none; font-size:0.7rem; font-weight:800; cursor:pointer;">SAIR DO SISTEMA</button>
            </div>
        </nav>
        <main id="chat-area">
            <header>
                <button class="apexia_back_btn" onclick="apexia_toggle_sidebar()">‚ò∞ MENU</button>
                <div style="font-weight:900; font-size:0.8rem; display:flex; align-items:center; gap:8px;">
                    APEXIA ELITE
                    <span id="apexia_notif_badge" class="apexia_notif_badge_click" onclick="apexia_toggleNotifPanel()" style="display:none; background:#ff4444; color:#fff; border-radius:50%; padding:2px 6px; font-size:0.6rem; font-weight:bold;">0</span>
                </div>
            </header>

            <!-- // ===============================
                 // IN√çCIO NOVA FUNCIONALIDADE: Painel de Notifica√ß√µes
                 // =============================== -->
            <div id="apexia_notifications_panel"></div>
            <!-- // ===============================
                 // FIM NOVA FUNCIONALIDADE
                 // =============================== -->

            <div id="apexia_news_carousel">
                <img id="apexia_news_carousel_img" src="" alt="">
                <div id="apexia_news_carousel_body">
                    <div id="apexia_news_carousel_title"></div>
                    <div id="apexia_news_carousel_desc"></div>
                </div>
                <div class="apexia_news_bullets" id="apexia_news_bullets"></div>
            </div>

            <div id="apexia_video_banner" style="display:none; background:rgba(255, 215, 0, 0.1); border-bottom:1px solid var(--gold); padding:10px 20px; text-align:center; font-size:0.8rem; z-index:10;">
                <span class="apexia_anim_icon">üé•</span> <b style="color:var(--gold);">NOVO V√çDEO:</b> <span id="apexia_video_banner_title" style="color:#fff;"></span>
                <span id="apexia_video_banner_time" style="font-size:0.6rem; opacity:0.6; margin-left:10px;"></span>
                <br><a id="apexia_video_banner_link" href="#" target="_blank">ASSISTIR AGORA üöÄ</a>
            </div>

            <!-- REGRA DO GRUPO (substitui √°rea de mensagem fixada) -->
            <div id="apexia_pin_banner" class="apexia_group_rule">
                <div class="apexia_group_rule_icon">üëÜ</div>
                <div class="apexia_group_rule_content">
                    <div class="apexia_group_rule_title">REGRA DO GRUPO</div>
                    <div class="apexia_group_rule_text">
                        Leia esta regra com aten√ß√£o antes de participar do chat. Respeite todos os membros e mantenha o foco nos temas da comunidade.
                    </div>
                </div>
            </div>

            <div id="apexia_unread_since_banner">
                <b id="apexia_unread_since_count">0</b> novas mensagens desde sua √∫ltima visita
            </div>

            <div id="chat-window"></div>
            
            <!-- // ===============================
                 // IN√çCIO NOVA FUNCIONALIDADE: Scroll Down Button
                 // =============================== -->
            <div id="apexia_scroll_down" onclick="document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;">‚Üì</div>
            <!-- // ===============================
                 // FIM NOVA FUNCIONALIDADE
                 // =============================== -->

            <div id="typingIndicator" style="font-size: 0.65rem; color: var(--primary); padding: 5px 25px; min-height: 22px; font-style: italic; opacity: 0.8;"></div>
            
            <div class="input-area" style="position:relative;">
                <div id="apexia_reply_preview">
                    <b id="apexia_reply_name">Nome</b>
                    <p id="apexia_reply_text" style="color:#aaa; margin-top:3px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></p>
                    <button onclick="apexia_limparResposta()" style="position:absolute; right:15px; top:15px; background:rgba(255,255,255,0.1); border:none; color:#fff; cursor:pointer; font-weight:bold; border-radius:50%; width:25px; height:25px; display:flex; align-items:center; justify-content:center;">X</button>
                </div>
                <div class="input-wrapper">
                    <label for="chat-file" style="cursor:pointer; font-size: 1.2rem; z-index: 5;">üìé</label>
                    <input type="file" id="chat-file" style="display:none" onchange="enviarAnexo()">
                    <input type="text" id="chat-input" placeholder="Mensagem ou link...">
                    <button class="send-btn" onclick="enviarMensagem()">‚Üí</button>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAIS E AUXILIARES -->
    <div id="apexia_member_modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:3000; align-items:center; justify-content:center; backdrop-filter:blur(10px);">
        <div class="modal-box" style="width:90%; max-width:350px; background:#0a0a0a; border:1px solid var(--primary); padding:30px; border-radius:25px; text-align:center; position:relative; box-shadow: 0 10px 30px rgba(0,255,0,0.1);">
            <button onclick="document.getElementById('apexia_member_modal').style.display='none'" style="position:absolute; top:15px; right:20px; background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">&times;</button>
            <img id="apexia_modal_foto" src="" style="width:80px; height:80px; border-radius:50%; border:2px solid var(--primary); object-fit:cover; margin-bottom:10px;">
            <h2 id="apexia_modal_nome" style="color:#fff; margin-bottom:5px; font-size:1.2rem;">-</h2>
            <p id="apexia_modal_bio" style="font-size:0.8rem; color:#aaa; margin-bottom:20px; font-style:italic;">-</p>
            <div style="text-align:left; background:#111; padding:15px; border-radius:15px; font-size:0.8rem; color:#ccc; margin-bottom:20px; border:1px solid #222;">
                <p><b>Idade:</b> <span id="apexia_modal_idade">-</span></p>
                <p style="margin-top:8px;"><b>Nacionalidade:</b> <span id="apexia_modal_nacionalidade">-</span></p>
                <p style="margin-top:8px;"><b>Interesses:</b> <span id="apexia_modal_interesses">-</span></p>
            </div>
            <a id="apexia_modal_wa" href="#" target="_blank" style="display:none; width:100%; padding:14px; background:#25D366; color:#fff; text-decoration:none; border-radius:50px; font-weight:900; font-size:0.8rem;">CHAMAR NO WHATSAPP</a>
        </div>
    </div>

    <div id="apexia_lightbox" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:100000; align-items:center; justify-content:center; flex-direction:column; backdrop-filter:blur(5px);" onclick="this.style.display='none'">
        <img id="apexia_lightbox_img" style="max-width:95%; max-height:80vh; border-radius:15px; border:2px solid var(--primary); object-fit:contain; box-shadow:0 10px 40px #000;">
        <span style="color:var(--primary); margin-top:20px; font-weight:900; font-size:0.8rem; cursor:pointer; background:rgba(0,255,0,0.1); padding:8px 20px; border-radius:50px;">FECHAR IMAGEM (X)</span>
    </div>

    <div id="apexia_emoji_panel" style="display:none; position:fixed; background:#111; border:1px solid var(--primary); border-radius:30px; padding:10px 15px; gap:15px; z-index:90000; box-shadow:0 10px 30px rgba(0,0,0,0.8);">
        <span onclick="apexia_addReaction('üòÇ')" style="font-size:1.5rem; cursor:pointer; transition:0.2s;">üòÇ</span>
        <span onclick="apexia_addReaction('üò¢')" style="font-size:1.5rem; cursor:pointer; transition:0.2s;">üò¢</span>
        <span onclick="apexia_addReaction('‚ù§Ô∏è')" style="font-size:1.5rem; cursor:pointer; transition:0.2s;">‚ù§Ô∏è</span>
        <span onclick="apexia_addReaction('üëç')" style="font-size:1.5rem; cursor:pointer; transition:0.2s;">üëç</span>
        <span onclick="apexia_addReaction('üî•')" style="font-size:1.5rem; cursor:pointer; transition:0.2s;">üî•</span>
    </div>

    <div id="apexia_msg_menu">
        <button data-action="emoji"><span>üòä</span>Reagir com emoji</button>
        <button data-action="reply"><span>‚Ü©Ô∏è</span>Responder</button>
        <button data-action="forward"><span>üì§</span>Reencaminhar</button>
        <button data-action="edit"><span>‚úèÔ∏è</span>Editar</button>
        <button data-action="delete"><span>üóëÔ∏è</span>Apagar</button>
    </div>

    <div id="apexia_sms_toast" style="position:fixed; top:20px; left:50%; transform:translate(-50%, -150%); background:rgba(20,20,20,0.95); border-left:4px solid var(--primary); color:#fff; padding:15px 20px; border-radius:12px; z-index:99999; box-shadow:0 10px 30px rgba(0,0,0,0.8); transition:transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); display:flex; gap:12px; align-items:center; min-width:300px; max-width:90vw; cursor:pointer;">
        <span style="font-size:1.8rem;">üí¨</span>
        <div style="flex:1;">
            <b id="apexia_sms_name" style="font-size:0.8rem; color:var(--primary);">Nome</b><br>
            <span id="apexia_sms_text" style="font-size:0.75rem; color:#ddd; word-break:break-word;">Mensagem</span>
        </div>
    </div>

    <div id="apexia_custom_modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:999999; align-items:center; justify-content:center; backdrop-filter:blur(5px);">
        <div style="background:#0a0a0a; border:1px solid var(--primary); padding:30px; border-radius:20px; text-align:center; max-width:350px; width:90%; box-shadow:0 15px 40px rgba(0,255,0,0.1);">
            <p id="apexia_modal_msg" style="margin-bottom:20px; font-size:0.85rem; line-height:1.5; color:#fff; font-weight:bold;"></p>
            <input type="text" id="apexia_modal_input" style="display:none; width:100%; padding:12px; margin-bottom:20px; background:#000; border:1px solid #333; color:#fff; border-radius:8px; outline:none;" />
            <div style="display:flex; gap:10px; justify-content:center;">
                <button id="apexia_modal_btn_cancel" style="display:none; flex:1; padding:12px; background:#222; color:#fff; border:none; border-radius:10px; cursor:pointer; font-weight:bold; transition:0.2s;">CANCELAR</button>
                <button id="apexia_modal_btn_confirm" style="flex:1; padding:12px; background:var(--primary); color:#000; border:none; border-radius:10px; cursor:pointer; font-weight:bold; transition:0.2s;">OK</button>
            </div>
        </div>
    </div>

    <!-- MODAL EXPANDIDO PARA SLIDES / AN√öNCIOS -->
    <div id="apexia_news_modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:120000; align-items:center; justify-content:center; padding:20px; backdrop-filter:blur(10px);">
        <div class="apexia_news_modal_box">
            <button type="button" class="apexia_news_modal_close">&times;</button>
            <img id="apexia_news_modal_img" alt="An√∫ncio" />
            <h3 id="apexia_news_modal_title"></h3>
            <p id="apexia_news_modal_desc"></p>
        </div>
    </div>

    <!-- BOT√ÉO PWA INSTALAR APP -->
    <div id="apexia_pwa_install">
        <span>üì≤</span>
        <span>Instalar APEXIA</span>
    </div>

    <script>
        const ADMIN_PHONE = "244931352915";
        const firebaseConfig = {
            apiKey: "AIzaSyBhdI1v1_3ycms26YQdYhy0_GSuuh2ZvJA",
            authDomain: "comunidade-apexia.firebaseapp.com",
            projectId: "comunidade-apexia",
            databaseURL: "https://comunidade-apexia-default-rtdb.firebaseio.com",
            storageBucket: "comunidade-apexia.firebasestorage.app",
            messagingSenderId: "668289488372",
            appId: "1:668289488372:web:cf29801db6489d09a695a1"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let myProfile = null, base64Proof = "", replyingTo = null;
        const msgIds = new Set();

        let apexia_unread_count = 0;
        let apexia_unread_list = [];
        const apexia_initTime = Date.now();
        let apexia_lastVisitKey = null;
        let apexia_toastTimeout = null;

        let apexia_news_items = [];
        let apexia_news_index = 0;
        let apexia_news_timer = null;

        function apexia_toggle_sidebar() { document.getElementById('sidebar').classList.toggle('open'); }

        function salvarPerfil() {
            const updates = {
                age: document.getElementById('p-age').value,
                interests: document.getElementById('p-interests').value,
                bio: document.getElementById('p-bio').value,
                nacionalidade: document.getElementById('p-nacionalidade').value,
                waContato: document.getElementById('p-whatsapp-contato').value
            };
            db.ref("users/" + myProfile.id).update(updates).then(() => {
                alert("Perfil Supremo Atualizado!");
                document.getElementById('profile-modal').style.display = 'none';
            });
        }

        function previewFile() {
            const file = document.getElementById('reg-photo').files[0];
            const reader = new FileReader();
            reader.onloadend = () => { base64Proof = reader.result; document.getElementById('file-label').innerText = "‚úÖ Print Carregado"; };
            reader.readAsDataURL(file);
        }

        function irParaLoginRapido() { document.getElementById('onboarding').style.display = 'none'; document.getElementById('returning-login').style.display = 'flex'; }

        function loginRapido() {
            const wa = document.getElementById('login-whatsapp').value.replace(/\D/g, "");
            db.ref("users").orderByChild("wa").equalTo(wa).once("value", snap => {
                if (snap.exists()) {
                    const uData = Object.values(snap.val())[0];
                    localStorage.setItem("apexia_user", JSON.stringify(uData));
                    location.reload();
                } else { alert("N√∫mero n√£o encontrado!"); }
            });
        }

        function solicitarAcesso() {
            const name = document.getElementById('reg-name').value.trim();
            const channel = document.getElementById('reg-channel').value.trim();
            const wa = document.getElementById('reg-whatsapp').value.replace(/\D/g, "");
            if (!name || !channel || wa.length < 9) { alert("Dados incompletos!"); return; }
            const isAdmin = wa === ADMIN_PHONE;
            if(!isAdmin && !base64Proof) { alert("Anexe o print!"); return; }

            const user = { id: "u"+Date.now(), name, channel, wa, photo: `https://robohash.org/${name}.png?set=set4`, proof: base64Proof, approved: isAdmin, role: isAdmin?'admin':'member', msgCount: 0, createdAt: Date.now() };
            
            db.ref("users/" + user.id).set(user).then(() => {
                localStorage.setItem("apexia_user", JSON.stringify(user));
                location.reload();
            });
        }

        window.onload = () => {
            const saved = localStorage.getItem("apexia_user");
            if (!saved) return;
            myProfile = JSON.parse(saved);

            db.ref("users/" + myProfile.id).on("value", snap => {
                const u = snap.val();
                if (!u) { sair(); return; }
                myProfile = u;
                if (u.rejectionReason) {
                    document.getElementById('waiting-screen').style.display = "flex";
                    document.getElementById('rejection-alert').style.display = "block";
                    document.getElementById('rejection-reason').innerText = u.rejectionReason;
                    return;
                }
                if (!u.approved) { document.getElementById('waiting-screen').style.display = "flex"; startTimer(u.createdAt); return; }

                document.getElementById('onboarding').style.display = "none";
                document.getElementById('app').style.display = "flex";
                if(myProfile.role === 'admin') {
                    document.getElementById('admin-btn').style.display = 'block';
                    document.body.classList.add('apexia_is_admin');
                    ouvirPendentes();
                }
                
                if(document.getElementById('apexia_p_name_input')) {
                    document.getElementById('apexia_p_name_input').value = myProfile.name || "";
                }

                iniciarSistema();
                apexia_setupLastVisit();
            });
        };

        function startTimer(created) {
            const end = created + (24 * 60 * 60 * 1000);
            setInterval(() => {
                const diff = end - Date.now();
                if(diff <= 0) { document.getElementById('timer').innerText = "Processando..."; return; }
                const h = Math.floor(diff / 3600000), m = Math.floor((diff % 3600000) / 60000), s = Math.floor((diff % 60000) / 1000);
                document.getElementById('timer').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            }, 1000);
        }

        function iniciarSistema() { ouvirChat(); setupPresence(); ouvirRanking(); }

        function enviarMensagem() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text || !myProfile) return;
            document.querySelector('.send-btn').click();
        }

        function enviarAnexo() {
            const file = document.getElementById('chat-file').files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                db.ref("messages").push({ senderId: myProfile.id, senderName: myProfile.name, text: "Enviou uma imagem", attachment: e.target.result, timestamp: Date.now() });
            };
            reader.readAsDataURL(file);
        }

        function ouvirChat() {
            db.ref("messages").limitToLast(30).on("child_added", snap => {
                if (msgIds.has(snap.key)) return;
                msgIds.add(snap.key);
                const m = snap.val();
                const win = document.getElementById('chat-window');
                const isMe = m.senderId === myProfile.id;
                const div = document.createElement('div');
                div.className = `msg ${isMe ? 'sent' : 'received'}`;
                div.dataset.key = snap.key;
                div.dataset.senderId = m.senderId || '';
                div.dataset.senderName = m.senderName || '';
                div.dataset.text = m.text || '';
                div.dataset.timestamp = m.timestamp || Date.now();
                let html = `<b>${m.senderName}</b><br>${m.text}`;
                if(m.attachment) html += `<br><img src="${m.attachment}" style="max-width:100%">`;
                div.innerHTML = html;
                win.appendChild(div);
                try {
                    apexia_setupLongPress(div);
                    apexia_bindReactionsListener(div, snap.key);
                } catch(e) {}

                win.scrollTop = win.scrollHeight;
            });
        }

        function toggleAdminDrawer() { const d = document.getElementById('admin-drawer'); d.style.display = d.style.display === 'block' ? 'none' : 'block'; }

        function ouvirPendentes() {
            db.ref("users").on("value", s => {
                const list = document.getElementById('pending-list'); list.innerHTML = "";
                s.forEach(child => {
                    const u = child.val();
                    if(!u.approved && !u.rejectionReason) {
                        list.innerHTML += `
                        <div class="pending-card">
                            <b>${u.name}</b> (${u.channel})<br>
                            <img src="${u.proof}" style="width:100%; border-radius:10px;">
                            <div style="display:flex; gap:10px; margin-top:10px;">
                                <button onclick="db.ref('users/${u.id}').update({approved:true})" style="flex:1; background:#0f0; border:none; padding:8px; border-radius:5px; font-weight:900; cursor:pointer;">APROVAR</button>
                                <button onclick="rejeitarComMotivo('${u.id}')" style="flex:1; background:#f00; border:none; padding:8px; border-radius:5px; color:#fff; cursor:pointer;">REJEITAR</button>
                            </div>
                        </div>`;
                    }
                });
            });
        }

        function rejeitarComMotivo(id) {
            const m = prompt("Motivo da rejei√ß√£o (ser√° exibido ao usu√°rio):");
            if(m) db.ref(`users/${id}`).update({ rejectionReason: m });
        }

        function sair() { localStorage.removeItem("apexia_user"); location.reload(); }

        function setupPresence() {
            const statusRef = db.ref(`status/${myProfile.id}`);
            db.ref('.info/connected').on('value', snap => {
                if (snap.val() === true) statusRef.onDisconnect().remove().then(() => statusRef.set({name: myProfile.name, photo: myProfile.photo, channel: myProfile.channel, msgCount: myProfile.msgCount || 0}));
            });
            db.ref('status').on('value', snap => {
                const list = document.getElementById('members-list'); list.innerHTML = "";
                snap.forEach(c => { const d = c.val(); list.innerHTML += `<div class="member-card"><img src="${d.photo}"> <div><b>${d.name}</b><br><small style="opacity:0.4">online</small></div></div>`; });
            });
        }

        function ouvirRanking() {
            db.ref("users").orderByChild("msgCount").limitToLast(3).on("value", s => {
                const list = document.getElementById('ranking-list'); list.innerHTML = "";
                s.forEach(c => { const u = c.val(); list.innerHTML = `<div>‚≠ê ${u.name} (${u.msgCount || 0} pts)</div>` + list.innerHTML; });
            });
        }

        const g = document.getElementById('galaxy');
        for (let i = 0; i < 40; i++) {
            const s = document.createElement('div');
            s.className = 'star';
            s.style.width = s.style.height = Math.random() * 2 + 'px';
            s.style.left = Math.random() * 100 + '%';
            s.style.top = Math.random() * 100 + '%';
            g.appendChild(s);
        }

        document.addEventListener('click', (e) => {
            const sidebar = document.getElementById('sidebar');
            const isClickInside = sidebar.contains(e.target) || e.target.closest('.apexia_back_btn');
            if (!isClickInside && sidebar.classList.contains('open') && window.innerWidth <= 768) {
                sidebar.classList.remove('open');
            }
            if(!e.target.closest('#apexia_notif_badge') && !e.target.closest('#apexia_notifications_panel')) {
                document.getElementById('apexia_notifications_panel').style.display = 'none';
            }
        });

        let apexia_touchStartX = 0;
        document.addEventListener('touchstart', e => { apexia_touchStartX = e.changedTouches[0].screenX; }, {passive: true});
        document.addEventListener('touchend', e => {
            let touchEndX = e.changedTouches[0].screenX;
            if (apexia_touchStartX - touchEndX > 50 && window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
            }
        });

        function apexia_uploadFotoPerfil(event) {
            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result;
                if(myProfile) {
                    myProfile.photo = base64;
                    db.ref("users/" + myProfile.id).update({ photo: base64 });
                    db.ref("status/" + myProfile.id).update({ photo: base64 });
                    const imgPreview = document.getElementById('apexia_foto_preview_img');
                    imgPreview.src = base64;
                    imgPreview.style.display = 'block';
                    alert("‚úÖ Foto carregada e salva! (O chat refletir√° na pr√≥xima vez)");
                }
            };
            reader.readAsDataURL(file);
        }

        document.getElementById('members-list').addEventListener('click', function(e) {
            const card = e.target.closest('.member-card');
            if(card) {
                const name = card.querySelector('b').innerText;
                apexia_exibirPerfilUsuario(name.replace('ADMIN', '').trim());
            }
        });
        
        document.getElementById('ranking-list').addEventListener('click', function(e) {
            if(e.target.innerText.includes('‚≠ê')) {
                const rawText = e.target.innerText.split('‚≠ê ')[1];
                if(rawText) {
                    const name = rawText.split(' (')[0];
                    apexia_exibirPerfilUsuario(name.replace('ADMIN', '').trim());
                }
            }
        });

        function apexia_exibirPerfilUsuario(name) {
            db.ref("users").orderByChild("name").equalTo(name).once("value", snap => {
                if(snap.exists()) {
                    const u = Object.values(snap.val())[0];
                    document.getElementById('apexia_modal_foto').src = u.photo || ('https://robohash.org/'+u.name+'.png?set=set4');
                    document.getElementById('apexia_modal_nome').innerText = u.name;
                    document.getElementById('apexia_modal_bio').innerText = u.bio || 'Sem biografia fornecida ainda...';
                    document.getElementById('apexia_modal_idade').innerText = u.age ? u.age + ' anos' : 'N√£o informado';
                    document.getElementById('apexia_modal_nacionalidade').innerText = u.nacionalidade || 'N√£o informado';
                    document.getElementById('apexia_modal_interesses').innerText = u.interests || 'Nenhum listado';
                    
                    const waBtn = document.getElementById('apexia_modal_wa');
                    if(u.waContato) {
                        waBtn.style.display = 'inline-block';
                        waBtn.href = 'https://wa.me/' + u.waContato;
                    } else {
                        waBtn.style.display = 'none';
                    }
                    document.getElementById('apexia_member_modal').style.display = 'flex';
                }
            });
        }

        function apexia_showNewMessageToast(m) {
            if (!myProfile || !m || m.senderId === myProfile.id) return;
            const toast = document.getElementById('apexia_sms_toast');
            if (!toast) return;
            const nameEl = document.getElementById('apexia_sms_name');
            const textEl = document.getElementById('apexia_sms_text');
            if (nameEl) nameEl.innerText = 'Algu√©m enviou uma mensagem';
            if (textEl) {
                const raw = (m.text || '').replace(/\[Resp.*\]\n/, '');
                const short = raw.length > 80 ? raw.substring(0, 80) + '...' : raw;
                textEl.innerText = short || 'Nova mensagem';
            }
            toast.classList.add('apexia_toast_visible');
            clearTimeout(apexia_toastTimeout);
            apexia_toastTimeout = setTimeout(() => {
                toast.classList.remove('apexia_toast_visible');
            }, 3000);
        }

        function apexia_setupLastVisit() {
            if (!myProfile) return;
            apexia_lastVisitKey = 'apexia_last_visit_' + myProfile.id;
            const stored = parseInt(localStorage.getItem(apexia_lastVisitKey) || '0', 10);
            if (!stored) return;

            db.ref("messages").orderByChild("timestamp").startAt(stored + 1).once("value", snap => {
                let count = 0;
                snap.forEach(c => {
                    const m = c.val();
                    if (m && m.senderId !== myProfile.id) count++;
                });
                const banner = document.getElementById('apexia_unread_since_banner');
                const countEl = document.getElementById('apexia_unread_since_count');
                if (banner && countEl && count > 0) {
                    countEl.innerText = count;
                    banner.style.display = 'flex';
                }
            });
        }

        window.addEventListener('beforeunload', () => {
            if (myProfile && apexia_lastVisitKey) {
                localStorage.setItem(apexia_lastVisitKey, Date.now().toString());
            }
        });

        function apexia_notificacoes() {
            db.ref("messages").orderByChild("timestamp").limitToLast(1).on("child_added", snap => {
                const m = snap.val();
                if(m.timestamp > apexia_initTime && m.senderId !== (myProfile ? myProfile.id : null)) {
                    const isMobileSidebarOpen = document.getElementById('sidebar').classList.contains('open');
                    const win = document.getElementById('chat-window');
                    const isAtBottom = win.scrollHeight - win.scrollTop <= win.clientHeight + 100;

                    if (document.hidden || !isAtBottom || (window.innerWidth <= 768 && isMobileSidebarOpen)) {
                        apexia_unread_count++;
                        apexia_unread_list.push(m);
                        apexia_updateBadge();
                    }
                    apexia_showNewMessageToast(m);
                }
            });

            document.getElementById('chat-input').addEventListener('focus', () => {
                apexia_unread_count = 0; apexia_unread_list = []; apexia_updateBadge();
            });
            document.getElementById('chat-window').addEventListener('click', () => {
                apexia_unread_count = 0; apexia_unread_list = []; apexia_updateBadge();
            });
        }

        function apexia_updateBadge() {
            const badge = document.getElementById('apexia_notif_badge');
            if(badge) {
                badge.style.display = apexia_unread_count > 0 ? 'inline-block' : 'none';
                badge.innerText = apexia_unread_count;
            }
            apexia_renderNotifPanel();
        }

        function apexia_renderNotifPanel() {
            const panel = document.getElementById('apexia_notifications_panel');
            panel.innerHTML = '<div style="padding:10px; border-bottom:1px solid rgba(0,255,0,0.2); font-size:0.7rem; color:var(--primary); font-weight:900; text-align:center;">MENSAGENS N√ÉO LIDAS</div>';
            if(apexia_unread_list.length === 0) {
                panel.style.display = 'none';
                return;
            }
            apexia_unread_list.forEach(m => {
                const d = new Date(m.timestamp);
                const timeStr = d.getHours().toString().padStart(2,'0') + ":" + d.getMinutes().toString().padStart(2,'0');
                const div = document.createElement('div');
                div.className = 'apexia_notif_item';
                div.innerHTML = `<div class="apexia_notif_header"><span>${m.senderName}</span><span>${timeStr}</span></div><div class="apexia_notif_body">${m.text.replace(/\[Resp.*\]/,'').substring(0,40)}...</div>`;
                div.onclick = () => {
                    document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;
                    panel.style.display = 'none';
                    apexia_unread_count = 0; apexia_unread_list = []; apexia_updateBadge();
                };
                panel.appendChild(div);
            });
        }

        function apexia_toggleNotifPanel() {
            const panel = document.getElementById('apexia_notifications_panel');
            panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
        }
        
        setTimeout(apexia_notificacoes, 2000);

        function apexia_novoVideo() {
            const title = document.getElementById('apexia_video_title').value.trim();
            const link = document.getElementById('apexia_video_link').value.trim();
            const desc = document.getElementById('apexia_video_desc').value.trim();
            
            if(!title || !link) { alert('Aviso: Preencha o T√≠tulo e o Link do v√≠deo!'); return; }
            
            db.ref("apexia_videos").push({
                title: title, 
                link: link, 
                desc: desc, 
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                alert('V√≠deo publicado! Os membros j√° foram notificados.');
                document.getElementById('apexia_video_title').value = '';
                document.getElementById('apexia_video_link').value = '';
                document.getElementById('apexia_video_desc').value = '';
            });
        }

        function apexia_escutarVideos() {
            db.ref("apexia_videos").limitToLast(1).on("child_added", snap => {
                const v = snap.val();
                const banner = document.getElementById('apexia_video_banner');
                if(banner && v.timestamp > (Date.now() - 86400000)) { 
                    banner.style.display = 'block';
                    document.getElementById('apexia_video_banner_title').innerText = v.title;
                    document.getElementById('apexia_video_banner_link').href = v.link;
                    const d = new Date(v.timestamp);
                    document.getElementById('apexia_video_banner_time').innerText = "Hoje " + d.getHours().toString().padStart(2,'0') + ":" + d.getMinutes().toString().padStart(2,'0');
                }
            });
        }
        
        function apexia_addNews() {
            if (!myProfile || myProfile.wa !== ADMIN_PHONE) {
                alert('Apenas o ADMIN pode cadastrar destaques.');
                return;
            }
            const titleEl = document.getElementById('apexia_news_title');
            const descEl = document.getElementById('apexia_news_desc');
            const imgEl = document.getElementById('apexia_news_img');
            const title = (titleEl.value || '').trim();
            const desc = (descEl.value || '').trim();
            if (!title) { alert('Informe um t√≠tulo para o destaque.'); return; }

            const pushNews = (image) => {
                db.ref('apexia_news').push({
                    title,
                    desc,
                    image: image || null,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                }).then(() => {
                    titleEl.value = '';
                    descEl.value = '';
                    imgEl.value = '';
                    alert('Destaque adicionado!');
                });
            };

            const file = imgEl.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => pushNews(e.target.result);
                reader.readAsDataURL(file);
            } else {
                pushNews(null);
            }
        }

        function apexia_renderNewsSlide() {
            const box = document.getElementById('apexia_news_carousel');
            if (!box) return;
            if (!apexia_news_items.length) {
                box.style.display = 'none';
                return;
            }
            const item = apexia_news_items[apexia_news_index % apexia_news_items.length];
            const img = document.getElementById('apexia_news_carousel_img');
            const title = document.getElementById('apexia_news_carousel_title');
            const desc = document.getElementById('apexia_news_carousel_desc');
            const bullets = document.getElementById('apexia_news_bullets');

            if (item.image) {
                img.src = item.image;
                img.style.display = 'block';
            } else {
                img.style.display = 'none';
            }
            title.textContent = item.title || '';
            let d = item.desc || '';
            if (d.length > 120) d = d.substring(0,117)+'...';
            desc.textContent = d;

            bullets.innerHTML = '';
            if (apexia_news_items.length > 1) {
                apexia_news_items.forEach((_, idx) => {
                    const dot = document.createElement('div');
                    dot.className = 'apexia_news_dot' + (idx === apexia_news_index ? ' active' : '');
                    bullets.appendChild(dot);
                });
            }

            box.style.display = 'flex';
            box.classList.remove('apexia_news_fade');
            void box.offsetWidth;
            box.classList.add('apexia_news_fade');
        }

        function apexia_startNewsRotation() {
            if (apexia_news_timer) clearInterval(apexia_news_timer);
            if (!apexia_news_items.length) return;
            apexia_news_timer = setInterval(() => {
                apexia_news_index = (apexia_news_index + 1) % apexia_news_items.length;
                apexia_renderNewsSlide();
            }, 60000);
        }

        function apexia_escutarNews() {
            db.ref('apexia_news').orderByChild('timestamp').limitToLast(10).on('value', snap => {
                const arr = [];
                snap.forEach(c => { arr.push(c.val()); });
                arr.sort((a,b) => (a.timestamp||0)-(b.timestamp||0));
                apexia_news_items = arr;
                apexia_news_index = 0;
                apexia_renderNewsSlide();
                apexia_startNewsRotation();
            });
        }

        document.addEventListener('click', (e) => {
            if(e.target.tagName === 'IMG' && e.target.closest('.msg')) {
                document.getElementById('apexia_lightbox_img').src = e.target.src;
                document.getElementById('apexia_lightbox').style.display = 'flex';
            }
        });

        document.getElementById('chat-window').addEventListener('scroll', function() {
            const btn = document.getElementById('apexia_scroll_down');
            if(this.scrollHeight - this.scrollTop - this.clientHeight > 150) {
                btn.style.display = 'flex';
            } else {
                btn.style.display = 'none';
            }

            const ruleBanner = document.getElementById('apexia_pin_banner');
            if (ruleBanner) {
                if (this.scrollTop <= 5) {
                    ruleBanner.style.transform = 'translateY(0)';
                    ruleBanner.style.opacity = '1';
                } else {
                    ruleBanner.style.transform = 'translateY(-100%)';
                    ruleBanner.style.opacity = '0';
                }
            }
        });

        const apexia_autoScrollCheck = setInterval(() => {
            if(document.getElementById('app').style.display === 'flex') {
                const cw = document.getElementById('chat-window');
                cw.scrollTop = cw.scrollHeight;
                clearInterval(apexia_autoScrollCheck);
            }
        }, 500);

        function apexia_estadoCarregando(botao) {
            if(botao.dataset.carregando === 'true') return;
            const originalTxt = botao.innerHTML;
            const originalWidth = botao.offsetWidth;
            botao.dataset.carregando = 'true';
            botao.style.width = originalWidth + 'px';
            botao.innerHTML = '<span class="apexia_spinner"></span> <span style="font-size:0.65rem; white-space:normal; line-height:1.2; display:inline-block; vertical-align:middle; text-align:left; text-transform:none;">Conectando...<br>Pode levar at√© 2 min.</span>';
            setTimeout(() => { botao.innerHTML = originalTxt; botao.style.width = ''; botao.dataset.carregando = 'false'; }, 6000);
        }

        document.addEventListener('click', (e) => {
            const botao = e.target.closest('.btn-join');
            if(botao && !botao.classList.contains('apexia_back_btn')) setTimeout(() => apexia_estadoCarregando(botao), 10);
        });

        function apexia_modalInterno(tipo, mensagem, callback) {
            const modal = document.getElementById('apexia_custom_modal');
            const btnCancel = document.getElementById('apexia_modal_btn_cancel');
            const btnConfirm = document.getElementById('apexia_modal_btn_confirm');
            const input = document.getElementById('apexia_modal_input');
            
            document.getElementById('apexia_modal_msg').innerText = mensagem;
            input.style.display = tipo === 'prompt' ? 'block' : 'none';
            input.value = '';
            btnCancel.style.display = (tipo === 'confirm' || tipo === 'prompt') ? 'block' : 'none';
            
            modal.style.display = 'flex';
            if(tipo === 'prompt') input.focus();
            
            const newConfirm = btnConfirm.cloneNode(true);
            btnConfirm.parentNode.replaceChild(newConfirm, btnConfirm);
            const newCancel = btnCancel.cloneNode(true);
            btnCancel.parentNode.replaceChild(newCancel, btnCancel);
            
            newCancel.onclick = () => { modal.style.display = 'none'; if(callback) callback(tipo === 'prompt' ? null : false); };
            newConfirm.onclick = () => { modal.style.display = 'none'; if(callback) callback(tipo === 'prompt' ? input.value : true); };
        }

        window.alert = function(msg) { apexia_modalInterno('alert', msg); };
        window.rejeitarComMotivo = function(id) { apexia_modalInterno('prompt', "Motivo da rejei√ß√£o (ser√° exibido ao usu√°rio):", (m) => { if(m) db.ref(`users/${id}`).update({ rejectionReason: m }); }); };

        window.addEventListener('click', function(e) {
            let btnSair = e.target.closest('button[onclick="sair()"]');
            if (btnSair) {
                e.stopImmediatePropagation(); e.preventDefault();
                apexia_modalInterno('confirm', "Ao sair ser√° necess√°rio inserir seu n√∫mero novamente. Deseja continuar?", (res) => { if(res) sair(); });
            }
        }, true);

        document.addEventListener('DOMContentLoaded', () => {
            const pinBanner = document.getElementById('apexia_pin_banner');
            if(pinBanner) {
                pinBanner.style.display = 'flex';
            }
            const unreadBanner = document.getElementById('apexia_unread_since_banner');
            if (unreadBanner) {
                unreadBanner.addEventListener('click', () => {
                    unreadBanner.style.display = 'none';
                    if (myProfile && apexia_lastVisitKey) {
                        localStorage.setItem(apexia_lastVisitKey, Date.now().toString());
                    }
                    const cw = document.getElementById('chat-window');
                    if (cw) cw.scrollTop = cw.scrollHeight;
                });
            }

            const newsBox = document.getElementById('apexia_news_carousel');
            if (newsBox) {
                newsBox.addEventListener('click', () => {
                    if (!apexia_news_items.length) return;
                    const item = apexia_news_items[apexia_news_index % apexia_news_items.length];
                    const modal = document.getElementById('apexia_news_modal');
                    if (!modal) return;
                    const imgEl = document.getElementById('apexia_news_modal_img');
                    const titleEl = document.getElementById('apexia_news_modal_title');
                    const descEl = document.getElementById('apexia_news_modal_desc');
                    titleEl.textContent = item.title || '';
                    descEl.textContent = item.desc || '';
                    if (item.image) {
                        imgEl.src = item.image;
                        imgEl.style.display = 'block';
                    } else {
                        imgEl.style.display = 'none';
                    }
                    modal.style.display = 'flex';
                });

                let newsTouchStartX = 0;
                newsBox.addEventListener('touchstart', (e) => {
                    if (!e.touches[0]) return;
                    newsTouchStartX = e.touches[0].clientX;
                }, { passive: true });
                newsBox.addEventListener('touchend', (e) => {
                    if (!e.changedTouches[0]) return;
                    const dx = e.changedTouches[0].clientX - newsTouchStartX;
                    if (Math.abs(dx) > 40) {
                        if (dx < 0) {
                            apexia_nextNews();
                        } else {
                            apexia_prevNews();
                        }
                    }
                });
            }

            const newsModal = document.getElementById('apexia_news_modal');
            if (newsModal) {
                const closeBtn = newsModal.querySelector('.apexia_news_modal_close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        newsModal.style.display = 'none';
                    });
                }
                newsModal.addEventListener('click', () => {
                    newsModal.style.display = 'none';
                });
            }
            setTimeout(apexia_escutarVideos, 1500);
            setTimeout(apexia_escutarNews, 1800);
        });

        let apexia_reply_data = null;
        function apexia_abrirPreviewResposta(nome, texto) {
            apexia_reply_data = { name: nome, text: texto.split('\n')[0].substring(0, 60) };
            document.getElementById('apexia_reply_name').innerText = nome;
            let t = apexia_reply_data.text;
            if (t.length > 60) t = t.substring(0,57)+'...';
            document.getElementById('apexia_reply_text').innerText = t;
            document.getElementById('apexia_reply_preview').style.display = 'block';
            document.getElementById('chat-input').focus();
        }
        function apexia_limparResposta() {
            apexia_reply_data = null;
            document.getElementById('apexia_reply_preview').style.display = 'none';
        }

        document.querySelector('.send-btn').addEventListener('click', function(e) {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text || !myProfile) return;
            
            e.preventDefault(); e.stopImmediatePropagation();

            let finalMsg = text;
            if(apexia_reply_data) {
                finalMsg = `[Resp. ${apexia_reply_data.name}: "${apexia_reply_data.text}"]\n` + text;
            }
            db.ref("messages").push({ senderId: myProfile.id, senderName: myProfile.name, text: finalMsg, timestamp: firebase.database.ServerValue.TIMESTAMP });
            db.ref(`users/${myProfile.id}/msgCount`).set((myProfile.msgCount || 0) + 1);
            
            input.value = "";
            apexia_limparResposta();
        }, true);

        document.getElementById('chat-input').addEventListener('keypress', function(e) {
            if(e.key === 'Enter') { e.preventDefault(); document.querySelector('.send-btn').click(); }
        });

        db.ref("messages").on("child_removed", snap => {
            const msgNode = document.querySelector(`.msg[data-key="${snap.key}"]`);
            if(msgNode) msgNode.remove();
        });

        const apexia_observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1) {
                        if (node.classList.contains('msg') && !node.dataset.apexiaProcessed) {
                            node.dataset.apexiaProcessed = "true";
                            const key = node.dataset.key;
                            const senderName = node.dataset.senderName || '';
                            const text = node.dataset.text || '';
                            const timestamp = parseInt(node.dataset.timestamp || Date.now(), 10);

                            if(text && text.includes('[Resp.')) {
                                const match = text.match(/\[Resp\. (.*?): "(.*?)"\]\n(.*)/s);
                                if(match) {
                                    const nome = match[1];
                                    let trecho = match[2] || '';
                                    if (trecho.length > 80) trecho = trecho.substring(0,77)+'...';
                                    node.innerHTML = `<b>${senderName}</b><br><span class="apexia_quoted_msg" data-reply-name="${nome}" data-reply-snippet="${trecho.replace(/"/g,'&quot;')}" data-parent-key="${key}"><b>${nome}</b><span>${trecho}</span></span>${match[3]}`;
                                    node.dataset.text = text;
                                }
                            }
                            const bTag = node.querySelector('b');
                            if(bTag) {
                                if(senderName.toLowerCase().includes('apexia') || senderName.toLowerCase().includes('admin') || node.dataset.senderId === 'u1711000000000') {
                                    if(!bTag.querySelector('.apexia_admin_badge')) {
                                        bTag.innerHTML += `<span class="apexia_admin_badge">ADMIN</span>`;
                                    }
                                    node.classList.add('apexia_admin_msg');
                                }
                            }
                            const timeSpan = document.createElement('div');
                            timeSpan.style.cssText = "font-size:0.55rem; opacity:0.5; text-align:right; margin-top:4px; font-weight:normal;";
                            const tDate = new Date(timestamp || Date.now());
                            timeSpan.innerText = tDate.getHours().toString().padStart(2,'0') + ":" + tDate.getMinutes().toString().padStart(2,'0');
                            node.appendChild(timeSpan);
                            
                            const actionContainer = document.createElement('div');
                            actionContainer.className = "apexia_action_btn";
                            
                            const btnResponder = document.createElement('span');
                            btnResponder.innerHTML = '‚Ü©Ô∏è';
                            btnResponder.style.cursor = 'pointer';
                            btnResponder.onclick = (e) => { e.stopPropagation(); apexia_abrirPreviewResposta(senderName, text); };
                            actionContainer.appendChild(btnResponder);

                            if(myProfile && node.dataset.senderId === myProfile.id) {
                                const btnApagar = document.createElement('span');
                                btnApagar.innerHTML = 'üóëÔ∏è';
                                btnApagar.style.cursor = 'pointer';
                                btnApagar.onclick = (e) => {
                                    e.stopPropagation();
                                    const k = node.dataset.key;
                                    if(!k) return;
                                    apexia_modalInterno('confirm', 'Apagar esta mensagem para todos?', res => {
                                        if(res) {
                                            db.ref("messages/" + k).remove();
                                            db.ref("messageReactions/" + k).remove();
                                        }
                                    });
                                };
                                actionContainer.appendChild(btnApagar);
                            }

                            node.appendChild(actionContainer);
                            apexia_setupLongPress(node);
                            apexia_bindReactionsListener(node, key);
                        }

                        if (node.classList.contains('member-card') && !node.dataset.apexiaStars) {
                            node.dataset.apexiaStars = "true";
                            const nameEl = node.querySelector('b');
                            if(nameEl) {
                                const mName = nameEl.innerText;
                                db.ref("users").orderByChild("name").equalTo(mName).once("value", snap => {
                                    if(snap.exists()){
                                        const u = Object.values(snap.val())[0];
                                        if(u.role === 'admin' || u.wa === ADMIN_PHONE) {
                                            nameEl.innerHTML += `<span class="apexia_admin_badge">ADMIN</span>`;
                                        }
                                        const msgs = u.msgCount || 0;
                                        let stars = msgs >= 50 ? 'üåüüåüüåü Elite' : (msgs >= 15 ? '‚≠ê‚≠ê Ativo' : '‚≠ê Novato');
                                        const starSpan = document.createElement('span');
                                        starSpan.innerHTML = `<br><small style="font-size:0.55rem; color:var(--gold); font-weight:bold;">${stars}</small>`;
                                        nameEl.parentNode.appendChild(starSpan);
                                    }
                                });
                            }
                        }
                    }
                });
            });
        });
        apexia_observer.observe(document.body, { childList: true, subtree: true });

        const apexia_fix_observer = new MutationObserver((mutations) => {
            mutations.forEach(m => {
                m.addedNodes.forEach(node => {
                    if (node.nodeType === 1 && node.classList.contains('msg')) {
                        const key = node.dataset.key;
                        if(key) {
                            db.ref("messages/" + key).once("value", snap => {
                                const data = snap.val();
                                if(!data) return;
                                let timeDiv = node.querySelector('div[style*=\"font-size:0.55rem\"]');
                                if(timeDiv) {
                                    timeDiv.innerText = apexia_formatarDataHora(data.timestamp);
                                    timeDiv.style.opacity = "0.7";
                                }
                                const bTag = node.querySelector('b');
                                if(bTag) {
                                    const isAdminReal = (data.senderId === myProfile?.id && apexia_verificarAdmin(myProfile)) || (data.wa === ADMIN_PHONE);
                                    const existingBadge = bTag.querySelector('.apexia_admin_badge');
                                    if(existingBadge && !isAdminReal) {
                                        existingBadge.remove();
                                        node.classList.remove('apexia_admin_msg');
                                        node.style.border = "none";
                                    } else if(isAdminReal && !existingBadge) {
                                        bTag.innerHTML += `<span class=\"apexia_admin_badge\">ADMIN</span>`;
                                        node.classList.add('apexia_admin_msg');
                                    }
                                }
                            });
                        }
                    }
                });
            });
        });
        apexia_fix_observer.observe(document.getElementById('chat-window'), { childList: true });

        setInterval(() => {
            document.querySelectorAll('.member-card').forEach(card => {
                const name = card.querySelector('b')?.innerText;
                const badge = card.querySelector('.apexia_admin_badge');
                if(badge && !name.includes('ApexiA') && !card.dataset.isAdminPhone) {
                    db.ref("users").orderByChild("name").equalTo(name.replace('ADMIN','').trim()).once("value", s => {
                       const u = Object.values(s.val() || {})[0];
                       if(u && u.wa === ADMIN_PHONE) card.dataset.isAdminPhone = "true";
                       else if(badge) badge.remove();
                    });
                }
            });
        }, 3000);

        document.getElementById('chat-window').addEventListener('click', (e) => {
            const quote = e.target.closest('.apexia_quoted_msg');
            if (!quote) return;
            const name = quote.getAttribute('data-reply-name') || '';
            const snippet = quote.getAttribute('data-reply-snippet') || '';
            if (!name || !snippet) return;
            const msgs = document.querySelectorAll('#chat-window .msg');
            let target = null;
            msgs.forEach(m => {
                if (target) return;
                const sender = m.dataset.senderName || '';
                const txt = m.dataset.text || '';
                if (sender === name && txt && txt.indexOf(snippet.substring(0,10)) !== -1) {
                    target = m;
                }
            });
            if (target) {
                target.classList.add('apexia_reply_highlight');
                target.scrollIntoView({behavior:'smooth', block:'center'});
                setTimeout(() => { target.classList.remove('apexia_reply_highlight'); }, 2000);
            }
        });

        function apexia_formatarDataHora(timestamp) {
            const d = new Date(timestamp);
            const dia = d.getDate().toString().padStart(2, '0');
            const mes = (d.getMonth() + 1).toString().padStart(2, '0');
            const ano = d.getFullYear();
            const hora = d.getHours().toString().padStart(2, '0');
            const min = d.getMinutes().toString().padStart(2, '0');
            return `${dia}/${mes}/${ano} √†s ${hora}:${min}`;
        }

        function apexia_verificarAdmin(usuario) {
            if (!usuario) return false;
            return usuario.wa === ADMIN_PHONE;
        }

        // =========================
        // SISTEMA DE MENU + REA√á√ïES
        // =========================
        let apexia_menuTargetNode = null;
        let apexia_reactionTargetKey = null;

        function apexia_openMsgMenu(target, clientX, clientY) {
            if (!target || !myProfile) return;
            const menu = document.getElementById('apexia_msg_menu');
            if (!menu) return;

            apexia_menuTargetNode = target;
            const key = target.dataset.key || '';
            const senderId = target.dataset.senderId || '';
            const isOwner = senderId === myProfile.id;
            const isAdmin = apexia_verificarAdmin(myProfile) || myProfile.role === 'admin';

            const btnEdit = menu.querySelector('button[data-action="edit"]');
            const btnDelete = menu.querySelector('button[data-action="delete"]');
            if (btnEdit) btnEdit.style.display = (isOwner || isAdmin) ? 'flex' : 'none';
            if (btnDelete) btnDelete.style.display = (isOwner || isAdmin) ? 'flex' : 'none';

            menu.style.display = 'flex';
            const rect = menu.getBoundingClientRect();
            let left = clientX;
            let top = clientY;
            if (left + rect.width > window.innerWidth) {
                left = window.innerWidth - rect.width - 10;
            }
            if (top + rect.height > window.innerHeight) {
                top = window.innerHeight - rect.height - 10;
            }
            menu.style.left = left + 'px';
            menu.style.top = top + 'px';
        }

        function apexia_setupLongPress(msgEl) {
            if (!msgEl || msgEl.dataset.longPressBound === '1') return;
            msgEl.dataset.longPressBound = '1';

            let pressTimer = null;

            msgEl.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                apexia_openMsgMenu(msgEl, e.clientX, e.clientY);
            });

            msgEl.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return;
                pressTimer = setTimeout(() => {
                    apexia_openMsgMenu(msgEl, e.clientX, e.clientY);
                }, 450);
            });
            ['mouseup', 'mouseleave'].forEach(ev => {
                msgEl.addEventListener(ev, () => {
                    if (pressTimer) {
                        clearTimeout(pressTimer);
                        pressTimer = null;
                    }
                });
            });

            msgEl.addEventListener('touchstart', (e) => {
                if (!e.touches[0]) return;
                const touch = e.touches[0];
                pressTimer = setTimeout(() => {
                    apexia_openMsgMenu(msgEl, touch.clientX, touch.clientY);
                }, 450);
            }, { passive: true });

            msgEl.addEventListener('touchend', () => {
                if (pressTimer) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                }
            });
            msgEl.addEventListener('touchmove', () => {
                if (pressTimer) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                }
            });
        }

        (function apexia_bindMenuActions() {
            const menu = document.getElementById('apexia_msg_menu');
            if (!menu) return;

            menu.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-action]');
                if (!btn) return;
                e.stopPropagation();
                const action = btn.dataset.action;
                const msg = apexia_menuTargetNode;
                menu.style.display = 'none';
                if (!msg) return;
                const key = msg.dataset.key || '';
                const senderName = msg.dataset.senderName || '';
                const text = msg.dataset.text || '';

                if (action === 'emoji') {
                    const panel = document.getElementById('apexia_emoji_panel');
                    if (!panel) return;
                    apexia_reactionTargetKey = key;
                    const rect = msg.getBoundingClientRect();
                    panel.style.display = 'flex';
                    panel.style.left = (rect.left + rect.width / 2) + 'px';
                    panel.style.top = (rect.top - 10) + 'px';
                } else if (action === 'reply') {
                    apexia_abrirPreviewResposta(senderName, text);
                } else if (action === 'forward') {
                    const input = document.getElementById('chat-input');
                    if (input) {
                        input.value = `üì§ Encaminhado de ${senderName}: ${text}`;
                        input.focus();
                    }
                } else if (action === 'edit') {
                    apexia_modalInterno('prompt', 'Editar mensagem:', (novo) => {
                        if (novo !== null && novo.trim() && key) {
                            db.ref("messages/" + key + "/text").set(novo.trim());
                        }
                    });
                } else if (action === 'delete') {
                    if (!key) return;
                    const senderId = msg.dataset.senderId || '';
                    const isOwner = senderId === myProfile.id;
                    const isAdmin = apexia_verificarAdmin(myProfile) || myProfile.role === 'admin';
                    if (!isOwner && !isAdmin) return;
                    apexia_modalInterno('confirm', 'Apagar esta mensagem para todos?', (res) => {
                        if (res) {
                            db.ref("messages/" + key).remove();
                            db.ref("messageReactions/" + key).remove();
                        }
                    });
                }
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('#apexia_msg_menu') && !e.target.closest('.msg')) {
                    menu.style.display = 'none';
                }
                const panel = document.getElementById('apexia_emoji_panel');
                if (panel && !e.target.closest('#apexia_emoji_panel')) {
                    panel.style.display = 'none';
                }
            });
        })();

        function apexia_addReaction(emoji) {
            const panel = document.getElementById('apexia_emoji_panel');
            if (panel) panel.style.display = 'none';
            if (!myProfile || !emoji || !apexia_reactionTargetKey) return;
            const ref = db.ref('messageReactions/' + apexia_reactionTargetKey + '/' + emoji + '/' + myProfile.id);
            ref.set(true);
        }

        function apexia_bindReactionsListener(msgEl, key) {
            if (!msgEl || !key || msgEl.dataset.reactionsBound === '1') return;
            msgEl.dataset.reactionsBound = '1';
            let bar = msgEl.querySelector('.apexia_reactions_bar');
            if (!bar) {
                bar = document.createElement('div');
                bar.className = 'apexia_reactions_bar';
                msgEl.appendChild(bar);
            }
            db.ref('messageReactions/' + key).on('value', (snap) => {
                bar.innerHTML = '';
                if (!snap.exists()) {
                    bar.style.display = 'none';
                    return;
                }
                const data = snap.val() || {};
                Object.keys(data).forEach((emoji) => {
                    const users = data[emoji] || {};
                    const count = Object.keys(users).length;
                    if (count > 0) {
                        const chip = document.createElement('span');
                        chip.className = 'apexia_reaction_chip';
                        chip.textContent = emoji + ' ' + count;
                        bar.appendChild(chip);
                    }
                });
                bar.style.display = bar.childNodes.length ? 'flex' : 'none';
            });
        }

        function apexia_nextNews() {
            if (!apexia_news_items.length) return;
            apexia_news_index = (apexia_news_index + 1) % apexia_news_items.length;
            apexia_renderNewsSlide();
            apexia_startNewsRotation();
        }

        function apexia_prevNews() {
            if (!apexia_news_items.length) return;
            apexia_news_index = (apexia_news_index - 1 + apexia_news_items.length) % apexia_news_items.length;
            apexia_renderNewsSlide();
            apexia_startNewsRotation();
        }

        // =========================
        // SERVICE WORKER + PWA INSTALL
        // =========================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(() => {});
            });
        }

        let apexia_pwa_prompt = null;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            apexia_pwa_prompt = e;
            const btn = document.getElementById('apexia_pwa_install');
            if (btn) {
                btn.style.display = 'flex';
            }
        });

        const apexia_pwa_btn = document.getElementById('apexia_pwa_install');
        if (apexia_pwa_btn) {
            apexia_pwa_btn.addEventListener('click', async () => {
                if (!apexia_pwa_prompt) return;
                const promptEvent = apexia_pwa_prompt;
                apexia_pwa_prompt = null;
                apexia_pwa_btn.style.display = 'none';
                try {
                    await promptEvent.prompt();
                } catch (err) {
                    // silencioso
                }
            });
        }
    </script>
</body>
</html>


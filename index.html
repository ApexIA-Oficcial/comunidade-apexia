<!-- TELA DE ESPERA BONITA -->
<div id="waiting-screen">
    <div class="waiting-card">
        <div class="loader-ring"></div>
        <h2 style="font-weight: 900; margin-bottom: 10px;">VALIDANDO <span style="color:var(--primary)">IDENTIDADE</span></h2>
        <p style="color: #aaa; font-size: 0.9rem; line-height: 1.5;">O Administrador est√° analisando o seu print de membro. Esse processo garante uma comunidade livre de intrusos.</p>
        
        <div class="timer-box">‚è∞ Resposta estimada: <span style="color:#fff">em algumas horas</span></div>
        <p style="font-size: 0.7rem; color: #444; margin-top: 10px;">(Prazo m√°ximo: 24h)</p>

        <button onclick="falarComAdmin()" style="margin-top: 30px; background: transparent; border: 1px solid #333; color: #666; padding: 12px 25px; border-radius: 50px; cursor: pointer; font-size: 0.75rem; font-weight: 800;">
            DEMOROU MAIS DE 24H? CLIQUE AQUI
        </button>
        <br>
        <button onclick="localStorage.clear(); location.reload();" style="margin-top: 15px; background: none; border: none; color: #333; font-size: 0.6rem; cursor: pointer; text-decoration: underline;">CANCELAR PEDIDO</button>
    </div>
</div>

<!-- TELA DE REGISTRO -->
<div id="onboarding">
    <div class="form-box">
        <img src="https://apexia-oficcial.github.io/ApexIA/canalapexia.png" style="width:70px; margin-bottom:15px; border-radius:50%; border:2px solid var(--primary);">
        <h2 style="margin-bottom:10px;">COMUNIDADE <span>APEXIA</span></h2>
        <p style="color:#aaa; font-size:0.75rem; margin-bottom:20px;">Exclusivo para membros do canal.</p>
        
        <input type="text" id="reg-name" placeholder="Seu Nome">
        <input type="text" id="reg-channel" placeholder="Nome do seu Canal">
        <input type="tel" id="reg-whatsapp" placeholder="WhatsApp (ex: 244...)">
        
        <p style="font-size: 0.65rem; color: var(--primary); margin-bottom: 5px; text-align: left; padding-left: 10px;">Anexe o print do YouTube Studio (Membro):</p>
        <label for="reg-photo" class="file-btn" id="file-label">Selecionar arquivo...</label>
        <input type="file" id="reg-photo" accept="image/*" style="display:none" onchange="previewFile()">
        
        <button class="btn-join" onclick="solicitarAcesso()">SOLICITAR ACESSO</button>
    </div>
</div>

<!-- PAINEL ADMIN -->
<div id="admin-drawer">
    <h3 style="color:var(--primary); font-size: 0.8rem; margin-bottom: 20px; font-weight: 900; text-transform: uppercase;">Aprova√ß√µes Pendentes</h3>
    <div id="pending-list"></div>
    <button onclick="toggleAdminDrawer()" style="width:100%; padding:15px; background:#111; border:1px solid #333; color:#fff; border-radius:15px; margin-top:10px; cursor:pointer; font-weight: 800;">FECHAR PAINEL</button>
</div>

<!-- APP PRINCIPAL -->
<div id="app" style="display:none; width: 100%; display: flex;">
    <nav id="sidebar">
        <div id="members-list"></div>
        <div style="padding:20px; border-top:1px solid var(--border);">
            <button onclick="toggleAdminDrawer()" id="admin-btn" style="display:none; width:100%; padding:12px; background:var(--primary); color:#000; font-weight:900; border:none; border-radius:12px; margin-bottom:12px; cursor:pointer;">PAINEL DE GEST√ÉO</button>
            <button onclick="sair()" style="color:#444; background:none; border:none; font-size:0.7rem; font-weight:800; cursor:pointer; width:100%; text-align:left;">SAIR DO SISTEMA</button>
        </div>
    </nav>

    <main id="chat-area">
        <header>
            <div style="font-weight: 900; font-size: 0.8rem;">COMUNIDADE <span>APEXIA</span> ELITE</div>
            <button onclick="window.location.href='https://apexia-oficcial.github.io/ApexIA/'" style="background:none; border:none; color:var(--primary); font-size:0.7rem; font-weight:800; cursor:pointer;">‚Üê HUB</button>
        </header>
        <div id="chat-window"></div>
        <div class="input-area">
            <div class="input-wrapper">
                <input type="text" id="chat-input" placeholder="Compartilhe sua estrat√©gia...">
                <button class="send-btn" onclick="enviarMensagem()">‚Üí</button>
            </div>
        </div>
    </main>
</div>

<script>
    const ADMIN_PHONE = "244931352915"; // SEU N√öMERO
    const firebaseConfig = {
        apiKey: "AIzaSyBhdI1v1_3ycms26YQdYhy0_GSuuh2ZvJA",
        authDomain: "comunidade-apexia.firebaseapp.com",
        projectId: "comunidade-apexia",
        databaseURL: "https://comunidade-apexia-default-rtdb.firebaseio.com",
        storageBucket: "comunidade-apexia.firebasestorage.app",
        messagingSenderId: "668289488372",
        appId: "1:668289488372:web:cf29801db6489d09a695a1"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let myProfile = null;
    let base64Proof = "";

    function previewFile() {
        const file = document.getElementById('reg-photo').files[0];
        const reader = new FileReader();
        reader.onloadend = () => { 
            base64Proof = reader.result; 
            document.getElementById('file-label').innerText = "‚úÖ " + file.name;
        };
        reader.readAsDataURL(file);
    }

    function falarComAdmin() {
        window.open(`https://wa.me/${ADMIN_PHONE}?text=Ol√°! Meu pedido de acesso √† Comunidade ApexiA est√° pendente h√° algum tempo. Pode verificar?`, '_blank');
    }

    function solicitarAcesso() {
        const name = document.getElementById('reg-name').value.trim();
        const channel = document.getElementById('reg-channel').value.trim();
        const wa = document.getElementById('reg-whatsapp').value.replace(/\D/g, "");
        
        if (!name || !channel || wa.length < 9) {
            alert("Preencha todos os dados corretamente!"); return;
        }

        const isAdmin = wa === ADMIN_PHONE;
        
        if(!isAdmin && !base64Proof) {
            alert("Voc√™ precisa anexar o print provando que √© membro!"); return;
        }

        const user = { 
            id: "u"+Date.now(), 
            name, 
            channel, 
            wa, 
            photo: `https://robohash.org/${name}.png?set=set4`, 
            proof: isAdmin ? "" : base64Proof, 
            approved: isAdmin, 
            role: isAdmin ? 'admin' : 'member' 
        };
        
        db.ref("users/" + user.id).set(user);
        localStorage.setItem("apexia_user", JSON.stringify(user));
        
        if(isAdmin) {
            location.reload();
        } else {
            document.getElementById('onboarding').style.display = "none";
            document.getElementById('waiting-screen').style.display = "flex";
        }
    }

    window.onload = () => {
        const saved = localStorage.getItem("apexia_user");
        if (!saved) return;
        myProfile = JSON.parse(saved);

        // Ouvinte em tempo real para mudan√ßas no perfil (como aprova√ß√£o)
        db.ref("users/" + myProfile.id).on("value", snap => {
            const u = snap.val();
            if (!u) return;
            
            myProfile = u;

            if (!u.approved) {
                document.getElementById('onboarding').style.display = "none";
                document.getElementById('waiting-screen').style.display = "flex";
                return;
            }

            // Se aprovado ou Admin, abre o app
            document.getElementById('onboarding').style.display = "none";
            document.getElementById('waiting-screen').style.display = "none";
            document.getElementById('app').style.display = "flex";
            
            if(myProfile.role === 'admin') {
                document.getElementById('admin-btn').style.display = 'block';
                ouvirPendentes();
            }
            iniciarSistema();
        });
    };

    function iniciarSistema() {
        ouvirChat();
        setupPresence();
    }

    function enviarMensagem() {
        const input = document.getElementById('chat-input');
        if (!input.value.trim()) return;
        db.ref("messages").push({ senderId: myProfile.id, senderName: myProfile.name, text: input.value.trim(), role: myProfile.role, timestamp: Date.now() });
        input.value = "";
    }

    function ouvirChat() {
        db.ref("messages").limitToLast(50).on("child_added", snap => {
            const m = snap.val();
            const win = document.getElementById('chat-window');
            const isMe = m.senderId === myProfile.id;
            const div = document.createElement('div');
            div.className = `msg ${isMe ? 'sent' : 'received'}`;
            div.innerHTML = `
                <b style="font-size:0.6rem; color:${m.role==='admin'?'#0f0':'#888'}">${m.senderName} ${m.role==='admin'?'üëë':''}</b><br>
                ${m.text}
            `;
            win.appendChild(div);
            win.scrollTop = win.scrollHeight;
        });
    }

    function toggleAdminDrawer() { 
        const d = document.getElementById('admin-drawer');
        d.style.display = d.style.display === 'block' ? 'none' : 'block';
    }

    function ouvirPendentes() {
        db.ref("users").on("value", s => {
            const list = document.getElementById('pending-list');
            list.innerHTML = "";
            s.forEach(child => {
                const u = child.val();
                if(!u.approved) {
                    list.innerHTML += `
                    <div class="pending-card">
                        <b style="font-size:0.9rem;">${u.name}</b><br>
                        <small style="color:#666">${u.channel}</small><br>
                        <img src="${u.proof}" onclick="window.open(this.src)" style="margin-top:10px;">
                        <button onclick="aprovarUser('${u.id}')" style="width:100%; background:#0f0; color:#000; border:none; padding:10px; border-radius:8px; cursor:pointer; font-weight:900;">APROVAR MEMBRO</button>
                    </div>`;
                }
            });
        });
    }

    function aprovarUser(id) { db.ref("users/"+id).update({ approved: true }); }
    function sair() { localStorage.removeItem("apexia_user"); location.reload(); }
    
    function setupPresence() {
        const statusRef = db.ref(`status/${myProfile.id}`);
        db.ref('.info/connected').on('value', snap => {
            if (snap.val() === true) statusRef.onDisconnect().remove().then(() => statusRef.set({name: myProfile.name, photo: myProfile.photo, channel: myProfile.channel}));
        });
        db.ref('status').on('value', snap => {
            const list = document.getElementById('members-list');
            list.innerHTML = "";
            snap.forEach(c => {
                const d = c.val();
                list.innerHTML += `<div class="member-card"><img src="${d.photo}"> <div><b>${d.name}</b><br><small style="opacity:0.4">${d.channel}</small></div></div>`;
            });
        });
    }

    // Estrelas
    const g = document.getElementById('galaxy');
    for (let i = 0; i < 40; i++) {
        const s = document.createElement('div');
        s.className = 'star';
        s.style.width = s.style.height = Math.random() * 2 + 'px';
        s.style.left = Math.random() * 100 + '%';
        s.style.top = Math.random() * 100 + '%';
        g.appendChild(s);
    }
    document.getElementById('chat-input').addEventListener('keypress', e => { if(e.key === 'Enter') enviarMensagem(); });
</script>
